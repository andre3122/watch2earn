<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Watch2Earn</title>
<link rel="preconnect" href="https://cdn.fluidplayer.com" crossorigin>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script defer src="https://cdn.fluidplayer.com/v3/current/fluidplayer.min.js"></script>
<!-- Monetag Mini App SDK -->
<script src="//libtl.com/sdk.js" data-zone="9711117" data-sdk="show_9711117"></script>
<style>
  :root{
    --bg:#f6f8fb;--card:#ffffff;--ink:#0b1220;--muted:#5b6b82;--line:#e7edf4;
    --brand1:#67d6ff;--brand2:#38e1b7;--brand:#4fd3ca;
    --pill-bg:#eef3f8;--pill-ink:#22324d;--accent:#316aff;
    --success:#22c55e;--warning:#f59e0b;--danger:#ef4444;
    --radius:16px;--pad:16px;--shadow:0 10px 30px rgba(16,24,40,.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:500 16px/1.4 Inter,system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:920px;margin:0 auto;padding:var(--pad);padding-bottom:96px}
  .appbar{display:flex;align-items:center;gap:12px;margin-bottom:12px}
  .logo{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#7ee8fa,#eec0c6)}
  .title{font-weight:800;font-size:20px}
  .chip{margin-left:auto;background:#0b1220;color:#fff;border-radius:999px;padding:6px 12px;font-weight:700}
  .chip small{opacity:.7;margin-left:6px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:var(--pad);box-shadow:var(--shadow);margin-bottom:12px}
  .card h3{margin:0 0 8px;font-size:18px}
  .muted{color:var(--muted)}
  .btn{appearance:none;border:0;border-radius:12px;padding:14px 16px;font-weight:800;color:#0b1220;background:#e8f0fb;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:linear-gradient(135deg,var(--brand1),var(--brand2));color:#08210f}
  .btn.ghost{background:var(--pill-bg);color:var(--pill-ink)}
  .btn.block{width:100%}
  .grid{display:grid;gap:12px}
  .g2{grid-template-columns:repeat(2,1fr)}
  .g3{grid-template-columns:repeat(3,1fr)}
  @media (min-width:600px){ .g3-lg{grid-template-columns:repeat(3,1fr)} }
  .stack{display:flex;flex-direction:column;gap:10px}
  .checkin{background:linear-gradient(135deg,#8fd3f4,#c793ff 40%,#f8ae55);color:#0b1220}
  .daygrid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:10px 0 12px}
  .day{background:rgba(255,255,255,.22);backdrop-filter:blur(2px);border:2px solid rgba(255,255,255,.5);
        color:#0b1220;border-radius:14px;padding:10px;text-align:center;font-weight:800}
  .day.lock{opacity:.6}
  .day.done{border-color:#34d399}
  .progress{height:8px;background:rgba(255,255,255,.35);border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0;background:#34d399}
  video{width:100%;border-radius:12px;border:1px solid var(--line);background:#000}
  .tabs{position:fixed;left:0;right:0;bottom:0;background:rgba(255,255,255,.7);backdrop-filter:blur(8px);
        border-top:1px solid var(--line);padding:10px}
  .tabbar{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;max-width:920px;margin:0 auto}
  .tab{border-radius:16px;background:var(--pill-bg);color:var(--pill-ink);text-align:center;padding:12px 10px;font-weight:800}
  .tab.active{outline:2px solid #d2e6ff;background:#f5f9ff}
  .tab small{display:block;color:var(--muted);font-weight:600}
  .row{display:flex;align-items:center;gap:10px}
  .between{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .chipBal{background:#0b1220;color:#fff;border-radius:20px;padding:6px 10px;font-weight:800}
  .field{width:100%;background:#f5f7fb;border:1px solid var(--line);border-radius:12px;padding:14px;color:var(--ink)}
  .hint{font-size:13px;color:var(--muted);margin-top:6px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  .hidden{display:none}
  /* hide until init done */
  html{visibility:hidden}
  html.init-ready{visibility:visible}
</style>
</head>
<body>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.documentElement.classList.add('init-ready');
  });
  setTimeout(() => document.documentElement.classList.add('init-ready'), 1500);
</script>

<div class="wrap">
  <!-- Header -->
  <div class="appbar">
    <div class="logo"></div>
    <div>
      <div class="title">Watch2Earn</div>
      <div class="muted" id="joinedTxt">Joined —</div>
    </div>
    <div class="chip" id="userChip">User</div>
  </div>

  <!-- HOME -->
  <section id="screen-home">
    <div class="grid g2">
      <div class="card">
        <div class="between">
          <h3>Balance</h3><div class="chipBal"><span id="balTop">0.00</span></div>
        </div>
        <div class="grid g2">
          <div>
            <div class="title" id="tasksDone">0</div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="between">
          <h3>Daily Streak</h3><div class="chipBal" id="streakChip">0</div>
        </div>
      </div>
    </div>

    <div class="card checkin">
      <h3>Daily Check-in Bonus</h3>
      <div class="muted">Claim your daily reward and keep your streak!</div>
      <div class="daygrid" id="dayGrid"></div>
      <div class="progress"><div class="bar" id="bar"></div></div>
      <div style="height:10px"></div>
      <button class="btn primary block" id="btnClaim">Claim <span id="claimAmt">+0.00</span> USDT</button>
    </div>

    <div class="card">
      <h3>Invite Friends & Earn</h3>
      <div class="muted" id="refPct">Earn 17% of your friends’ earnings.</div>
      <div class="row" style="margin-top:8px">
        <input id="refLink" class="field mono" readonly value=""/>
        <button class="btn ghost" id="copyRef">Copy</button>
      </div>
    </div>
  </section>

  <!-- ADS -->
  <section id="screen-ads" class="hidden">
    <!-- Follow Telegram Task -->
    <div class="card" style="margin-top:12px">
      <div class="between">
        <div class="title">Follow Telegram</div>
        <div class="muted">Reward: <span id="followRewardTxt">0.01</span> USDT</div>
      </div>
      <div class="muted" style="margin:6px 0 10px">Join channel untuk klaim reward sekali saja.</div>
      <div class="grid g2">
        <button class="btn primary" id="btnOpenChannel">Open Channel</button>
        <button class="btn ghost" id="btnClaimFollow">Claim Reward</button>
      </div>
      <div class="hint" id="followStat" style="margin-top:8px"></div>
    </div>

    <!-- Completed Tasks -->
    <div class="card">
      <h3>Complete Tasks</h3>
      <div class="stack" style="margin-top:8px">
        <button class="btn primary block" id="btnRewPopup">Rewarded Popup</button>
        <button class="btn primary block" id="btnRewInter">Rewarded Interstitial</button>
      </div>
    </div>
  </section>

  <!-- REFER -->
  <section id="screen-refer" class="hidden">
    <div class="card">
      <h3>Refer & Earn</h3>
      <div class="muted">Share your referral link to grow faster.</div>
      <div class="row" style="margin-top:8px">
        <input id="refLink2" class="field mono" readonly value=""/>
        <button class="btn ghost" id="copyRef2">Copy</button>
      </div>
      <div class="card" style="margin-top:12px">
        <div class="between"><div class="muted">Referrals</div><div class="chipBal" id="refCount">0</div></div>
        <div id="refList" class="muted" style="margin-top:8px">Your referrals will appear here.</div>
      </div>
    </div>
  </section>

  <!-- PROFILE -->
  <section id="screen-profile" class="hidden">
    <div class="card">
      <div class="between">
        <h3>Profile</h3>
        <div class="chipBal"><span id="balProf">0.00</span> USDT</div>
      </div>
      <div class="muted"><span id="profName">User</span> • Joined <span id="joinedDate">—</span></div>
    </div>

    <div class="card">
      <h3>Withdraw</h3>
      <div class="muted">Minimum: <b id="minWdTxt">1</b> USDT</div>
      <div style="height:10px"></div>
      <div>Amount</div>
      <input id="wdAmt" class="field" placeholder="Enter amount (USDT)" inputmode="decimal">
      <div class="hint">Minimum withdraw is <span id="minWdHint">1</span> USDT.</div>
      <div style="height:10px"></div>
      <div>Wallet Address</div>
      <input id="wdAddr" class="field" placeholder="Wallet address (e.g., TON / TRC20)">
      <div class="hint">Enter the address for your selected network (e.g., TON address or TRC20 USDT).</div>
      <div style="height:12px"></div>
      <button class="btn primary block" id="btnWithdraw">Request Withdraw</button>
    </div>
  </section>
</div>

<!-- Tabs -->
<div class="tabs">
  <div class="tabbar">
    <button class="tab active" data-tab="home">Home</button>
    <button class="tab" data-tab="ads">Ads</button>
    <button class="tab" data-tab="refer">Refer</button>
    <button class="tab" data-tab="profile">Profile</button>
  </div>
</div>

<script>
(function () {
  const tg = window.Telegram?.WebApp;
  tg && tg.expand();

  // === CONFIG (frontend) ===
  const BOT_USERNAME     = 'watch2earnreal_bot';
  const API_URL          = '/api';
  const REWARD_PER_TASK  = 0.01;
  const REF_BONUS_PCT    = 17;
  const MIN_WITHDRAW     = 1;
  const VAST_TAG         = '';
  const FALLBACK_SEC     = 15;
  const CHANNEL_USERNAME = 'watch2earnreal';
  const FOLLOW_REWARD    = 0.01;

  // === USER storage unik ===
  const UID   = tg?.initDataUnsafe?.user?.id || 'guest';
  const LSKEY = `w2e_state_v2_${UID}`;

  // === helpers DOM aman ===
  const el = (id)=>document.getElementById(id);
  const setText = (id, txt)=>{ const n = el(id); if (n) n.textContent = txt; };

  // === state ===
  const state = loadState();
  function loadState(){
    const d = JSON.parse(localStorage.getItem(LSKEY) || '{}');
    return Object.assign({
      balance:0, totalEarned:0, tasksDone:0,
      streak:0, lastCheck:'', join:'',
      refs:[], wallet:''
    }, d);
  }
  function save(){ localStorage.setItem(LSKEY, JSON.stringify(state)); syncUI(); }

  // init join date
  if(!state.join){
    const now = new Date();
    state.join = `${String(now.getDate()).padStart(2,'0')}/${String(now.getMonth()+1).padStart(2,'0')}/${now.getFullYear()}`;
    save();
  }

  // header / identity
  const uname = tg?.initDataUnsafe?.user?.username || tg?.initDataUnsafe?.user?.first_name || 'User';
  setText('userChip', uname);
  setText('joinedTxt', `Joined ${state.join}`);

  // referral
  const refUrl = `https://t.me/${BOT_USERNAME}?start=${UID}`;
  const ref1 = el('refLink');  if (ref1) ref1.value = refUrl;
  const ref2 = el('refLink2'); if (ref2) ref2.value = refUrl;
  setText('refPct', `Earn ${REF_BONUS_PCT}% of your friends’ earnings.`);

  // profile info
  setText('profName', uname);
  setText('joinedDate', state.join);
  setText('minWdTxt', MIN_WITHDRAW);
  setText('minWdHint', MIN_WITHDRAW);

  // ===== Check-in =====
  const dayRewards = [0.02,0.04,0.06,0.08,0.10,0.12,0.15];
  const dayGrid = el('dayGrid');
  (function buildDays(){
    if (!dayGrid) return;
    dayGrid.innerHTML = '';
    for(let i=0;i<7;i++){
      const d = document.createElement('div');
      d.className = 'day lock';
      d.innerHTML = `Day ${i+1}<div style="font-weight:900">${dayRewards[i]}</div>`;
      dayGrid.appendChild(d);
    }
  })();

  const btnClaim = el('btnClaim');
  const bar      = el('bar');
  const claimAmt = el('claimAmt');

  function todayStr(){
    const n = new Date();
    return `${n.getFullYear()}-${n.getMonth()+1}-${n.getDate()}`;
  }
  function updateCheckinUI(){
    if (!bar || !dayGrid || !btnClaim || !claimAmt) return;
    const t = todayStr();
    const canClaim = (state.lastCheck !== t);
    const progress = Math.min(state.streak/7,1)*100;
    bar.style.width = progress + '%';
    claimAmt.textContent = '+' + dayRewards[(state.streak)%7].toFixed(2);
    [...dayGrid.children].forEach((e,i)=>{
      e.classList.remove('done'); e.classList.add('lock');
      if(i < state.streak) e.classList.add('done');
      if(i <= state.streak) e.classList.remove('lock');
    });
    btnClaim.disabled = !canClaim;
    btnClaim.textContent = canClaim
      ? `Claim ${dayRewards[(state.streak)%7].toFixed(2)} USDT`
      : 'Already claimed today';
  }
  if (btnClaim) btnClaim.addEventListener('click', ()=>{
    const t = todayStr();
    if (state.lastCheck === t) return;
    const amt = dayRewards[(state.streak)%7];
    state.balance += amt;
    state.totalEarned += amt;
    state.streak = Math.min(state.streak+1, 7);
    state.lastCheck = t;
    save();
    toast(`+${amt.toFixed(2)} USDT added`);
  });

  // ===== (opsional) VAST player – aman kalau elemen tidak ada =====
  const playerWrap     = el('playerWrap');
  const v              = el('player');
  const btnStartStream = el('btnStartStream');
  const fbNeed         = el('fallbackNeed');
  if (fbNeed) fbNeed.textContent = 15;
  let fp=null, fallbackTimer=null, watchdog=null, watched=0, rewarded=false;

  function showRewardPopup(amount=REWARD_PER_TASK, via=''){
    const msg = `+${amount.toFixed(2)} USDT credited${via?` (${via})`:''}.`;
    if (tg?.showPopup) tg.showPopup({title:'Reward',message:msg,buttons:[{type:'ok'}]});
    else alert(msg);
  }
  function creditTask(via=''){
    if (rewarded) return;
    rewarded = true;
    clearInterval(fallbackTimer); clearTimeout(watchdog);
    try{ fp && fp.destroy && fp.destroy(); }catch(e){}
    state.balance += REWARD_PER_TASK;
    state.totalEarned += REWARD_PER_TASK;
    state.tasksDone += 1;
    save();
    showRewardPopup(REWARD_PER_TASK, via);
  }
  if (btnStartStream && playerWrap && v){
    btnStartStream.addEventListener('click', async ()=>{
      rewarded=false; watched=0;
      playerWrap.classList.remove('hidden');
      v.innerHTML = '<source src="data:video/mp4;base64," type="video/mp4">';
      clearTimeout(watchdog);
      watchdog = setTimeout(()=>creditTask('watchdog'), 45000);
      try{ fp && fp.destroy && fp.destroy(); }catch(e){}
      if (VAST_TAG){
        fp = fluidPlayer('player', {
          layoutControls:{fillToContainer:true,allowDownload:false,playbackRateEnabled:false},
          vastOptions:{adList:[{roll:'preRoll',vastTag:VAST_TAG,skippable:true}],vpaidMode:'INSECURE',maxAllowedVastTagRedirects:5}
        });
        fp.on('adEnded', ()=>creditTask('vast-end'));
      }
      clearInterval(fallbackTimer);
      fallbackTimer = setInterval(()=>{
        if (!v.paused && document.visibilityState==='visible'){
          watched++;
          if (watched >= FALLBACK_SEC){ clearInterval(fallbackTimer); creditTask('fallback'); }
        }
      },1000);
      try{ await v.play(); }catch(e){}
    });
  }

  // ===== Monetag SDK buttons (null-safe) =====
  function genReqId(){ return `${Date.now()}_${Math.random().toString(36).slice(2,8)}`; }
  const g = (name)=>window[name];
  async function runMonetagAndCredit(runFn, label){
    rewarded=false;
    let guard = setTimeout(()=>creditTask(`${label}-guard`), 45000);
    try{ await runFn(); creditTask(label); }catch(_){ /* guard jalan */ }finally{ clearTimeout(guard); }
  }
  const btnRewPopup = el('btnRewPopup');
  if (btnRewPopup) btnRewPopup.onclick = ()=>{
    const reqid = genReqId();
    const fn = ()=> g('show_9711117')?.({ type:'pop', sub1: UID, sub2: reqid }) ?? Promise.reject();
    return runMonetagAndCredit(fn, 'popup');
  };
  const btnRewInter = el('btnRewInter');
  if (btnRewInter) btnRewInter.onclick = ()=>{
    const reqid = genReqId();
    const fn = ()=> g('show_9711117')?.({ sub1: UID, sub2: reqid }) ?? Promise.reject();
    return runMonetagAndCredit(fn, 'interstitial');
  };

  // ===== Follow Telegram =====
  setText('followRewardTxt', FOLLOW_REWARD.toFixed(2));
  const btnOpenChannel = el('btnOpenChannel');
  if (btnOpenChannel) btnOpenChannel.onclick = ()=>{
    const url = `https://t.me/${CHANNEL_USERNAME}`;
    if (tg?.openTelegramLink) tg.openTelegramLink(url); else window.open(url, '_blank');
  };
  const btnClaimFollow = el('btnClaimFollow');
  const followStat     = el('followStat');

  async function apiPost(path, body){
    const r = await fetch(`${API_URL}${path}`, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(body||{})
    });
    let data=null; try{ data=await r.json(); }catch(_){}
    if (!r.ok) throw (data || { ok:false, error:`HTTP ${r.status}` });
    return data;
  }
  if (btnClaimFollow) btnClaimFollow.onclick = async ()=>{
    if (!tg?.initData) { toast('Please open from Telegram.', true); return; }
    btnClaimFollow.disabled = true;
    if (followStat) followStat.textContent = 'Checking...';
    try{
      const res = await apiPost('/follow/claim', { initData: tg.initData });
      if (res?.ok){
        const delta = Number(res.balance_delta||0);
        if (delta>0){
          state.balance += delta; state.totalEarned += delta; state.tasksDone += 1; save();
          toast(`+${delta.toFixed(2)} USDT credited (follow)`);
          if (followStat) followStat.textContent = 'Reward claimed ✔';
        } else {
          if (followStat) followStat.textContent = 'Already claimed before.';
        }
      } else {
        if (followStat) followStat.textContent = res?.error || 'Error';
      }
    }catch(e){
      const msg = (e && (e.error || e.message)) || 'Server error';
      if (followStat) followStat.textContent = msg;
      toast(msg, true);
    }finally{
      btnClaimFollow.disabled = false;
    }
  };

  // ===== Withdraw =====
  const btnWithdraw = el('btnWithdraw');
  if (btnWithdraw) btnWithdraw.addEventListener('click', ()=>{
    const amt = parseFloat((el('wdAmt')?.value||'0').replace(',','.'));
    const addr = (el('wdAddr')?.value||'').trim();
    if(!amt || amt<MIN_WITHDRAW) return toast(`Minimum withdraw is ${MIN_WITHDRAW} USDT`, true);
    if(amt>state.balance) return toast(`Insufficient balance`, true);
    if(addr.length<10) return toast(`Enter a valid wallet address`, true);
    state.balance -= amt; save();
    toast(`Withdrawal requested: ${amt.toFixed(2)} USDT to ${addr}`);
  });

  // ===== Tabs =====
  const screens = { home:el('screen-home'), ads:el('screen-ads'), refer:el('screen-refer'), profile:el('screen-profile') };
  document.querySelectorAll('.tab').forEach(b=>{
    b.addEventListener('click',()=>{
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      b.classList.add('active');
      const k=b.dataset.tab;
      Object.entries(screens).forEach(([key,sec])=>{ if (sec) sec.classList.toggle('hidden', key!==k); });
      window.scrollTo({top:0,behavior:'instant'});
    });
  });

  // Copy helpers
  const copyRef = el('copyRef'); if (copyRef) copyRef.onclick = ()=>navigator.clipboard.writeText(refUrl).then(()=>toast('Copied'));
  const copyRef2= el('copyRef2');if (copyRef2)copyRef2.onclick= ()=>navigator.clipboard.writeText(refUrl).then(()=>toast('Copied'));

  // Toast
  function toast(msg, isErr=false){
    if (tg?.showPopup) tg.showPopup({title:isErr?'Oops':'Success', message:msg, buttons:[{type:'ok'}]});
    else alert(msg);
  }

  // Sync UI (null-safe)
  function syncUI(){
    setText('balTop',   state.balance.toFixed(2));
    setText('balProf',  state.balance.toFixed(2));
    setText('totalEarn',state.totalEarned.toFixed(2)+' USDT'); // aman kalau elemen tidak ada
    setText('tasksDone',String(state.tasksDone));
    setText('streakChip', state.streak + ' 🔥');
    updateCheckinUI();
  }
  syncUI();
})();
</script>
</body>
</html>
