<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Watch2Earn ‚Ä¢ Mini App</title>

<!-- Telegram WebApp SDK -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Fluid Player (VAST) -->
<link rel="preconnect" href="https://cdn.fluidplayer.com" crossorigin>
<script defer src="https://cdn.fluidplayer.com/v3/current/fluidplayer.min.js"></script>

<!-- Monetag SDK (ganti data-zone dengan milikmu) -->
<script src="https://libtl.com/sdk.js" data-zone="9711117" data-sdk="show_9711117"></script>

<style>
:root{
  --bg:#f7f9fc; --card:#ffffff; --muted:#637083; --fg:#0f172a; --line:#e6ebf2;
  --grad1:#6ea8ff; --grad2:#6ef3c5;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
  background:var(--bg); color:var(--fg);
  padding-bottom: calc(72px + env(safe-area-inset-bottom)); /* ruang untuk nav */
}
.app{max-width:960px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column}

/* Header */
.header{position:sticky;top:0;z-index:5;background:#fff;border-bottom:1px solid var(--line)}
.header .row{display:flex;align-items:center;gap:12px;padding:12px 16px}
.brand{display:flex;align-items:center;gap:10px}
.logo{width:38px;height:38px;border-radius:12px;
  background:linear-gradient(145deg,var(--grad1),var(--grad2));display:grid;place-items:center;
  color:#073b2d;font-weight:800;box-shadow:0 8px 24px rgba(80,130,255,.25)}
.name{font-weight:800}
.badge{margin-left:auto;padding:6px 10px;border-radius:999px;background:#eef2ff;color:#3730a3;font-weight:700;font-size:12px}

/* Content & cards */
.content{padding:16px;flex:1}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.card{grid-column:span 12;background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;
  box-shadow:0 10px 24px rgba(15,23,42,.06); line-height:1.25}
.card h3{margin:0 0 8px 0;font-size:16px}
.row{display:flex;justify-content:space-between;gap:10px;align-items:center}
.kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.kpi .it{background:linear-gradient(180deg,#f8fbff,#f1f5ff);border:1px solid var(--line);border-radius:14px;padding:12px}
.kpi .it small{color:var(--muted)}
.kpi .it b{font-size:18px}

/* Buttons & inputs */
.btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer;line-height:1.1}
.btn[disabled]{opacity:.6;cursor:not-allowed}
.btn.primary{background:linear-gradient(145deg,var(--grad1),var(--grad2));color:#073b2d}
.btn.outline{background:#fff;border:1px solid var(--line);color:var(--fg)}
input,select{width:100%;background:#fff;border:1px solid var(--line);border-radius:10px;padding:12px;color:var(--fg);line-height:1.1}

/* Video */
video{width:100%;border-radius:14px;border:1px solid var(--line)}

/* Sections */
.section{display:none;animation:fade .2s ease}
.section.active{display:block}
@keyframes fade{from{opacity:.4;transform:translateY(4px)}to{opacity:1;transform:none}}

/* Bottom Nav (fixed + safe area) */
.nav{
  position:fixed; left:0; right:0; bottom:0; z-index:10;
  background:#fff; border-top:1px solid var(--line); padding-bottom: env(safe-area-inset-bottom);
}
.tabs{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:6px;padding:8px}
.tab{display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px;border-radius:12px;color:var(--muted);font-size:12px;min-width:0}
.tab.active{background:#eef2ff;color:#1e293b;border:1px solid var(--line)}
.tab i{width:20px;height:20px;display:inline-grid;place-items:center;line-height:20px}
.tab span{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

@media(min-width:720px){ .col6{grid-column:span 6} }
.helper{color:var(--muted);font-size:12px}
</style>
</head>
<body>
<div class="app">

  <!-- Header -->
  <div class="header">
    <div class="row">
      <div class="brand">
        <div class="logo">W2E</div>
        <div class="name">Watch2Earn</div>
      </div>
      <div class="badge" id="uName">User</div>
      <div class="helper" id="uId"></div>
    </div>
  </div>

  <!-- Content -->
  <div class="content">

    <!-- HOME -->
    <section id="home" class="section active">
      <div class="grid">
        <div class="card">
          <h3>Overview</h3>
          <div class="kpi">
            <div class="it"><small>Balance</small><b id="kpiBalance">0.00 USDT</b></div>
            <div class="it"><small>Total Earned</small><b id="kpiEarned">0.00 USDT</b></div>
            <div class="it"><small>Tasks Done</small><b id="kpiTasks">0</b></div>
            <div class="it"><small>Streak</small><b id="kpiStreak">0 üî•</b></div>
          </div>
        </div>

        <div class="card col6">
          <h3>Daily Check-in Bonus</h3>
          <div class="helper">Claim your daily reward and keep your streak!</div>
          <div class="row" style="margin-top:10px">
            <button class="btn primary" id="btnCheckin">Claim Today</button>
            <div class="helper" id="ciStatus"></div>
          </div>
        </div>

        <div class="card col6">
          <h3>Ads Task Overview</h3>
          <div class="helper">Start a task and watch till completion to earn rewards.</div>
          <div class="row" style="margin-top:10px">
            <button class="btn primary" id="btnStartTask">Start Task</button>
          </div>
          <div id="vastWrap" style="margin-top:10px;display:none">
            <video id="vastVideo" controls preload="metadata" playsinline webkit-playsinline></video>
            <div class="helper" style="margin-top:8px">Fallback: <span id="fbNow">0</span>s / <span id="fbNeed">15</span>s</div>
          </div>
        </div>
      </div>
    </section>

    <!-- ADS TASK -->
    <section id="ads" class="section">
      <div class="grid">
        <div class="card">
          <h3>Ads Task</h3>
          <div style="display:grid;gap:10px;margin-top:12px">
            <div class="row" style="background:#f8fbff;border:1px solid var(--line);border-radius:12px;padding:10px">
              <div><b>Video Task (pre-roll)</b><div class="helper">Watch the video until it finishes</div></div>
              <button class="btn primary" id="taskVastBtn">Start Task</button>
            </div>
            <div class="row" style="background:#f8fffb;border:1px solid var(--line);border-radius:12px;padding:10px">
              <div><b>Rewarded Popup</b><div class="helper">One tap to open and complete</div></div>
              <button class="btn outline" id="taskPopBtn">Start Task</button>
            </div>
            <div class="row" style="background:#fff8fb;border:1px solid var(--line);border-radius:12px;padding:10px">
              <div><b>Rewarded Interstitial</b><div class="helper">Full-screen view</div></div>
              <button class="btn outline" id="taskIntBtn">Start Task</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- TG TASKS -->
    <section id="tg" class="section">
      <div class="grid"><div class="card"><h3>Telegram Tasks</h3><div class="helper">No tasks available</div></div></div>
    </section>

    <!-- REFER -->
    <section id="ref" class="section">
      <div class="grid">
        <div class="card">
          <h3>Refer & Earn Forever</h3>
          <div class="helper">Earn <b id="rfPct">10%</b> of your friends‚Äô earnings for life.</div>
          <div style="display:flex;gap:8px;margin-top:10px">
            <input id="rfLink" readonly>
            <button class="btn outline" id="btnCopyRef">Copy</button>
          </div>
        </div>
      </div>
    </section>

    <!-- WITHDRAW -->
    <section id="withdraw" class="section">
      <div class="grid">
        <div class="card col6">
          <h3>Withdraw Funds</h3>
          <div class="helper">Balance: <b id="wlBalance">0.00 USDT</b></div>
          <div class="helper">Minimum: <b id="wlMin">1 USDT</b></div>
          <div style="display:grid;gap:8px;margin-top:10px">
            <input id="wdAddr" placeholder="Wallet / account address">
            <button class="btn primary" id="btnWithdraw">Request Withdrawal</button>
            <div class="helper" id="wdMsg"></div>
          </div>
        </div>
        <div class="card col6">
          <h3>History</h3>
          <div class="helper">Transactions & recent rewards (coming soon)</div>
        </div>
      </div>
    </section>

    <!-- PROFILE -->
    <section id="profile" class="section">
      <div class="grid">
        <div class="card col6">
          <h3>Profile</h3>
          <div><b id="profName">User</b> ‚Ä¢ <span class="helper" id="profJoin"></span></div>
          <div class="helper" id="pfInfo">Loading profile‚Ä¶</div>
          <div class="row" style="gap:8px;margin-top:10px">
            <button class="btn outline" id="btnRefresh">Refresh</button>
            <div><div class="helper">Language</div>
              <select id="langSel"><option value="en">English</option><option value="id">Indonesia</option></select>
            </div>
          </div>
        </div>
        <div class="card col6">
          <h3>App Info</h3>
          <div class="helper">UI: <b>Light 1.0</b> ‚Ä¢ Player: Fluid (VAST) ‚Ä¢ SDK: Monetag</div>
        </div>
      </div>
    </section>

  </div>

  <!-- Bottom Nav -->
  <div class="nav">
    <div class="tabs" id="tabs">
      <div class="tab active" data-go="home"><i>üè†</i><span>Home</span></div>
      <div class="tab" data-go="ads"><i>üÑ∞</i><span>Ads Task</span></div>
      <div class="tab" data-go="tg"><i>‚úîÔ∏è</i><span>TG Tasks</span></div>
      <div class="tab" data-go="ref"><i>üë•</i><span>Refer</span></div>
      <div class="tab" data-go="withdraw"><i>üíº</i><span>Withdraw</span></div>
      <div class="tab" data-go="profile"><i>üë§</i><span>Profile</span></div>
    </div>
  </div>
</div>

<script>
/* ===== Telegram init & theming ===== */
const tg = window.Telegram.WebApp; tg.expand();
try{
  tg.setHeaderColor?.('secondary_bg_color');
  tg.setBackgroundColor?.(tg.themeParams?.bg_color || '#ffffff');
}catch{}

/* ===== Helpers ===== */
const $ = (s)=>document.querySelector(s);
const api = (p,b)=>fetch(p,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(b||{})}).then(r=>r.json());

/* ===== User & cache ===== */
const UID = String(tg.initDataUnsafe?.user?.id || 'guest');
const CACHE_KEY = `w2e_cache_${UID}`;
function loadCache(){
  try{
    const c = JSON.parse(localStorage.getItem(CACHE_KEY) || '{}');
    if (c.balance!=null) $('#kpiBalance').textContent = `${(+c.balance).toFixed(2)} USDT`;
    if (c.earned !=null) $('#kpiEarned').textContent  = `${(+c.earned).toFixed(2)} USDT`;
    if (c.tasks  !=null) $('#kpiTasks').textContent   = `${(+c.tasks)}`;
    if (c.streak !=null) $('#kpiStreak').textContent  = `${(+c.streak)} üî•`;
    if (c.balance!=null) $('#wlBalance').textContent  = `${(+c.balance).toFixed(2)} USDT`;
  }catch{}
}
function saveCache(d){
  const c = { balance:d.balance, earned:d.earned||0, tasks:d.total_tasks||0, streak:d.streak||0 };
  localStorage.setItem(CACHE_KEY, JSON.stringify(c));
}
loadCache();

/* ===== State ===== */
let CFG={vastTag:'',reward:0.01,min_withdraw:1,ref_pct:10,balance:0,total_tasks:0,username:'User',user_id:'',streak:0,earned:0};
let FP=null, adDone=false, fbTimer=0, fbNeed=15, lastT=0;

/* ===== Tabs ===== */
const sections=[...document.querySelectorAll('.section')];
$('#tabs').addEventListener('click',e=>{
  const t=e.target.closest('.tab'); if(!t) return;
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active'); const go=t.dataset.go;
  sections.forEach(s=>s.classList.toggle('active', s.id===go));
  if(go==='profile') loadConfig();
});

/* ===== Language (UI ringan; konten tak diubah) ===== */
const langSel=$('#langSel');
langSel.value = (localStorage.getItem('w2e_lang') || (tg.initDataUnsafe?.user?.language_code?.startsWith('id')?'id':'en'));
langSel.addEventListener('change', ()=>localStorage.setItem('w2e_lang', langSel.value));

/* ===== Load config from backend ===== */
async function loadConfig(){
  const d = await api('/api/config',{initData:tg.initData||''});
  if(!d.ok){ $('#pfInfo').textContent='Verification failed'; return; }
  CFG = d;

  // Fallback nilai agar tidak "undefined"
  CFG.ref_pct = (d.ref_pct ?? 10);
  $('#rfPct').textContent = `${CFG.ref_pct}%`;

  // Update UI
  $('#uName').textContent = d.username || 'User';
  $('#uId').textContent   = d.user_id ? ('#'+d.user_id) : '';
  $('#kpiBalance').textContent = `${d.balance.toFixed(2)} USDT`;
  $('#kpiEarned').textContent  = `${(d.earned||0).toFixed(2)} USDT`;
  $('#kpiTasks').textContent   = `${d.total_tasks||0}`;
  $('#kpiStreak').textContent  = `${d.streak||0} üî•`;
  $('#wlBalance').textContent  = `${d.balance.toFixed(2)} USDT`;
  $('#wlMin').textContent      = `${d.min_withdraw} USDT`;
  $('#fbNeed').textContent     = (d.min_watch_sec||15); fbNeed = d.min_watch_sec||15;
  $('#profName').textContent   = d.username || 'User';
  $('#profJoin').textContent   = d.joined_at ? `Joined ${d.joined_at}` : '';

  // Referral link dengan fallback
  try{
    const rl = await api('/api/ref/link',{initData:tg.initData||''});
    if(rl.ok && rl.link) $('#rfLink').value = rl.link;
    else {
      const bot = 'watch2earnreal_bot'; // ganti jika nama bot berbeda
      const uid = tg.initDataUnsafe?.user?.id || '';
      $('#rfLink').value = `https://t.me/${bot}?start=${uid}`;
    }
  }catch(e){
    const bot = 'watch2earnreal_bot';
    const uid = tg.initDataUnsafe?.user?.id || '';
    $('#rfLink').value = `https://t.me/${bot}?start=${uid}`;
  }

  // simpan cache agar tampilan tidak nol saat reopen
  saveCache(d);
}
loadConfig();

/* ===== Start video task (VAST) ===== */
const v=$('#vastVideo'), vastWrap=$('#vastWrap');
async function startVideoTask(){
  if(!CFG.vastTag){ alert('Ad source not configured.'); return; }
  const s = await api('/api/task/start',{initData:tg.initData||''});
  if(!s.ok){ alert(s.error||'Start failed'); return; }
  const taskId = s.task_id; adDone=false; lastT=0; fbTimer=0; $('#fbNow').textContent='0';
  vastWrap.style.display='block';
  v.innerHTML='<source src="data:video/mp4;base64," type="video/mp4">';
  if(FP&&FP.destroy) try{FP.destroy()}catch(_){}
  FP = fluidPlayer('vastVideo',{
    layoutControls:{fillToContainer:true,allowDownload:false,playbackRateEnabled:false},
    vastOptions:{adList:[{roll:'preRoll',vastTag:CFG.vastTag,skippable:true}],vpaidMode:'INSECURE',maxAllowedVastTagRedirects:5}
  });
  FP.on('adEnded', async ()=>{
    if(adDone) return; adDone=true;
    const r = await api('/api/task/complete',{initData:tg.initData||'',task_id:taskId});
    if(r.ok){ alert(`+${CFG.reward} USDT credited.`); loadConfig(); }
  });
  v.addEventListener('timeupdate', ()=>{
    const dt=Math.max(0, v.currentTime - lastT); lastT=v.currentTime;
    if(document.visibilityState==='visible' && !v.paused) fbTimer+=dt;
    $('#fbNow').textContent = String(Math.floor(fbTimer));
    if(!adDone && fbTimer>=fbNeed){
      adDone=true;
      api('/api/task/complete',{initData:tg.initData||'',task_id:taskId}).then(r=>{
        if(r.ok){ alert(`+${CFG.reward} USDT (fallback).`); loadConfig(); }
      });
    }
  });
  try{ await v.play(); }catch(_){}
}
$('#btnStartTask').addEventListener('click', startVideoTask);
$('#taskVastBtn').addEventListener('click', startVideoTask);

/* ===== Rewarded Popup / Interstitial ===== */
async function runReward(fn){
  const s = await api('/api/task/start',{initData:tg.initData||''});
  if(!s.ok){ alert(s.error||'Start failed'); return; }
  const taskId=s.task_id;
  try{
    await fn(); // selesai nonton
    const r=await api('/api/task/complete',{initData:tg.initData||'',task_id:taskId});
    if(r.ok){ alert(`+${CFG.reward} USDT`); loadConfig(); }
  }catch{ /* user close / error */ }
}
$('#taskPopBtn').addEventListener('click',()=>runReward(()=>show_9711117('pop')));
$('#taskIntBtn').addEventListener('click',()=>runReward(()=>show_9711117()));

/* ===== Check-in ===== */
$('#btnCheckin').addEventListener('click', async ()=>{
  const r = await api('/api/checkin',{initData:tg.initData||''});
  if(r.ok){ $('#ciStatus').textContent = `+${r.amount} USDT ‚Ä¢ Streak ${r.streak} üî•`; loadConfig(); }
  else { $('#ciStatus').textContent = r.error || 'Failed'; }
});

/* ===== Withdraw ===== */
$('#btnWithdraw').addEventListener('click', async ()=>{
  const a=$('#wdAddr').value.trim();
  const r=await api('/api/withdraw',{initData:tg.initData||'',address:a});
  $('#wdMsg').textContent = r.ok ? 'Request created.' : (r.error || 'Failed');
});

/* ===== Copy referral ===== */
$('#btnCopyRef').addEventListener('click',()=>{
  const el=$('#rfLink'); el.select(); document.execCommand('copy');
  tg.HapticFeedback?.notificationOccurred('success');
});

/* ===== Profile refresh ===== */
$('#btnRefresh').addEventListener('click', loadConfig);
</script>
</body>
</html>
