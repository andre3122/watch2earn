<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Watch2Earn • Mini App</title>

<!-- Telegram WebApp SDK -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Fluid Player (untuk VAST) -->
<link rel="preconnect" href="https://cdn.fluidplayer.com" crossorigin>
<script defer src="https://cdn.fluidplayer.com/v3/current/fluidplayer.min.js"></script>

<!-- Monetag (libtl) – ganti data-zone dengan punyamu -->
<script src="https://libtl.com/sdk.js" data-zone="9711117" data-sdk="show_9711117"></script>

<style>
:root{
  --bg:#f7f9fc; --card:#ffffff; --muted:#637083; --fg:#0f172a; --line:#e6ebf2;
  --grad1:#6ea8ff; --grad2:#6ef3c5; --brand:#4f46e5; --primary:#2563eb; --danger:#ef4444;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--fg)}
.app{max-width:960px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column}

/* Header */
.header{position:sticky;top:0;z-index:5;background:#fffcc;
  background:linear-gradient(180deg,#ffffff 60%,rgba(255,255,255,.85));
  border-bottom:1px solid var(--line)}
.header .row{display:flex;align-items:center;gap:12px;padding:12px 16px}
.brand{display:flex;align-items:center;gap:10px}
.logo{width:38px;height:38px;border-radius:12px;
  background:linear-gradient(145deg,var(--grad1),var(--grad2));display:grid;place-items:center;
  color:#fff;font-weight:800;box-shadow:0 8px 24px rgba(80,130,255,.35)}
.name{font-weight:800;letter-spacing:.2px}
.badge{margin-left:auto;padding:6px 10px;border-radius:999px;
  background:#eef2ff;color:#3730a3;font-weight:700;font-size:12px}

/* Content & cards */
.content{padding:16px;flex:1}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.card{grid-column:span 12;background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;
  box-shadow:0 10px 24px rgba(15,23,42,.06)}
.card h3{margin:0 0 8px 0;font-size:16px}
.row{display:flex;justify-content:space-between;gap:10px;align-items:center}
.kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.kpi .it{background:linear-gradient(180deg,#f8fbff,#f1f5ff);border:1px solid var(--line);border-radius:14px;padding:12px}
.kpi .it small{color:var(--muted)}
.kpi .it b{font-size:18px}

/* Buttons */
.btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
.btn[disabled]{opacity:.6;cursor:not-allowed}
.btn.primary{background:linear-gradient(145deg,var(--grad1),var(--grad2));color:#073b2d}
.btn.outline{background:#fff;border:1px solid var(--line);color:var(--fg)}
.btn.danger{background:linear-gradient(145deg,#ff9aa5,#ff6b6b);color:#4a0a0a}

/* Video */
video{width:100%;border-radius:14px;border:1px solid var(--line)}

/* Sections */
.section{display:none;animation:fade .2s ease}
.section.active{display:block}
@keyframes fade{from{opacity:.4;transform:translateY(4px)}to{opacity:1;transform:none}}

/* Bottom Nav */
.nav{position:sticky;bottom:0;z-index:5;background:#fff;border-top:1px solid var(--line)}
.tabs{display:grid;grid-template-columns:repeat(6,1fr);gap:6px;padding:8px}
.tab{display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px;border-radius:12px;color:var(--muted);font-size:12px}
.tab.active{background:#eef2ff;color:#1e293b;border:1px solid var(--line)}
.tab i{font-style:normal}

/* Responsive */
@media(min-width:720px){ .col6{grid-column:span 6} }
input,select{width:100%;background:#fff;border:1px solid var(--line);border-radius:10px;padding:12px;color:var(--fg)}
.helper{color:var(--muted);font-size:12px}
</style>
</head>
<body>
<div class="app">

  <!-- Header -->
  <div class="header">
    <div class="row">
      <div class="brand">
        <div class="logo">W2E</div>
        <div class="name" data-i18n="brand">Watch2Earn</div>
      </div>
      <div class="badge" id="uName">Guest</div>
      <div class="helper" id="uId"></div>
    </div>
  </div>

  <!-- Content -->
  <div class="content">

    <!-- HOME -->
    <section id="home" class="section active">
      <div class="grid">
        <div class="card">
          <h3 data-i18n="overview_title">Overview</h3>
          <div class="kpi">
            <div class="it"><small data-i18n="balance">Balance</small><b id="kpiBalance">0.00 USDT</b></div>
            <div class="it"><small data-i18n="earned">Total Earned</small><b id="kpiEarned">0.00 USDT</b></div>
            <div class="it"><small data-i18n="completed">Tasks Done</small><b id="kpiTasks">0</b></div>
            <div class="it"><small data-i18n="streak">Streak</small><b id="kpiStreak">0 🔥</b></div>
          </div>
        </div>

        <div class="card col6">
          <h3 data-i18n="daily_checkin">Daily Check-in Bonus</h3>
          <div class="helper" data-i18n="checkin_hint">Claim your daily reward and keep your streak!</div>
          <div class="row" style="margin-top:10px">
            <button class="btn primary" id="btnCheckin" data-i18n="claim_btn">Claim Today</button>
            <div class="helper" id="ciStatus"></div>
          </div>
        </div>

        <div class="card col6">
          <h3 data-i18n="quick_start">Ads Task Overview</h3>
          <div class="row" style="gap:8px;flex-wrap:wrap">
            <div class="helper" data-i18n="ads_hint">Start a task and watch till completion to earn rewards.</div>
            <button class="btn primary" id="btnStartTask" data-i18n="start_task">Start Task</button>
          </div>
          <div id="vastWrap" style="margin-top:10px;display:none">
            <video id="vastVideo" controls preload="metadata" playsinline webkit-playsinline></video>
            <div class="helper" style="margin-top:8px"><span data-i18n="fallback">Fallback</span>: <span id="fbNow">0</span>s / <span id="fbNeed">15</span>s</div>
          </div>
        </div>
      </div>
    </section>

    <!-- ADS TASK (khusus tugas iklan) -->
    <section id="ads" class="section">
      <div class="grid">
        <div class="card">
          <h3 data-i18n="ads_title">Ads Task</h3>
          <div class="helper" data-i18n="ads_sub">Pick a format below. Rewards are added after completion.</div>
          <div style="display:grid;gap:10px;margin-top:12px">
            <div class="row" style="background:#f8fbff;border:1px solid var(--line);border-radius:12px;padding:10px">
              <div><b data-i18n="ads_item1">Video Task (pre-roll)</b><div class="helper" data-i18n="ads_item1_hint">Watch the video until it finishes</div></div>
              <button class="btn primary" id="taskVastBtn" data-i18n="start_task">Start Task</button>
            </div>
            <div class="row" style="background:#f8fffb;border:1px solid var(--line);border-radius:12px;padding:10px">
              <div><b data-i18n="ads_item2">Rewarded Popup</b><div class="helper" data-i18n="ads_item2_hint">One tap to open and complete</div></div>
              <button class="btn outline" id="taskPopBtn" data-i18n="start_task">Start Task</button>
            </div>
            <div class="row" style="background:#fff8fb;border:1px solid var(--line);border-radius:12px;padding:10px">
              <div><b data-i18n="ads_item3">Rewarded Interstitial</b><div class="helper" data-i18n="ads_item3_hint">Full-screen view</div></div>
              <button class="btn outline" id="taskIntBtn" data-i18n="start_task">Start Task</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- TG TASKS (placeholder) -->
    <section id="tg" class="section">
      <div class="grid">
        <div class="card">
          <h3 data-i18n="tg_title">Telegram Tasks</h3>
          <div class="helper" data-i18n="tg_empty">No tasks available</div>
        </div>
      </div>
    </section>

    <!-- REFER -->
    <section id="ref" class="section">
      <div class="grid">
        <div class="card">
          <h3 data-i18n="ref_title">Refer & Earn Forever</h3>
          <div class="helper"><span data-i18n="ref_text1">Earn</span> <b id="rfPct">10%</b> <span data-i18n="ref_text2">of your friends’ earnings for life.</span></div>
          <div style="display:flex;gap:8px;margin-top:10px">
            <input id="rfLink" readonly>
            <button class="btn outline" id="btnCopyRef" data-i18n="copy_btn">Copy</button>
          </div>
        </div>
      </div>
    </section>

    <!-- WITHDRAW -->
    <section id="withdraw" class="section">
      <div class="grid">
        <div class="card col6">
          <h3 data-i18n="wd_title">Withdraw Funds</h3>
          <div class="helper"><span data-i18n="your_balance">Balance</span>: <b id="wlBalance">0.00 USDT</b></div>
          <div class="helper"><span data-i18n="min_wd">Minimum</span>: <b id="wlMin">1 USDT</b></div>
          <div style="display:grid;gap:8px;margin-top:10px">
            <input id="wdAddr" placeholder="Wallet / account address">
            <button class="btn primary" id="btnWithdraw" data-i18n="withdraw_btn">Request Withdrawal</button>
            <div class="helper" id="wdMsg"></div>
          </div>
        </div>
        <div class="card col6">
          <h3 data-i18n="history_title">History</h3>
          <div class="helper" data-i18n="history_hint">Transactions & recent rewards (coming soon)</div>
        </div>
      </div>
    </section>

    <!-- PROFILE -->
    <section id="profile" class="section">
      <div class="grid">
        <div class="card col6">
          <h3 data-i18n="profile_title">Profile</h3>
          <div><b id="profName">User</b> • <span class="helper" id="profJoin"></span></div>
          <div class="helper" id="pfInfo" data-i18n="profile_loading">Loading profile…</div>
          <div class="row" style="gap:8px;margin-top:10px">
            <button class="btn outline" id="btnRefresh" data-i18n="refresh_btn">Refresh</button>
            <div>
              <div class="helper" data-i18n="lang_label">Language</div>
              <select id="langSel"><option value="en">English</option><option value="id">Indonesia</option></select>
            </div>
          </div>
        </div>
        <div class="card col6">
          <h3 data-i18n="about_title">App Info</h3>
          <div class="helper">UI: <b>Light 1.0</b> • Player: Fluid (VAST) • SDK: Monetag</div>
        </div>
      </div>
    </section>

  </div>

  <!-- Bottom Nav -->
  <div class="nav">
    <div class="tabs" id="tabs">
      <div class="tab active" data-go="home"><i>🏠</i><span data-i18n="tab_home">Home</span></div>
      <div class="tab" data-go="ads"><i>🄰</i><span data-i18n="tab_ads">Ads Task</span></div>
      <div class="tab" data-go="tg"><i>✔️</i><span data-i18n="tab_tg">TG Tasks</span></div>
      <div class="tab" data-go="ref"><i>👥</i><span data-i18n="tab_ref">Refer</span></div>
      <div class="tab" data-go="withdraw"><i>💼</i><span data-i18n="tab_withdraw">Withdraw</span></div>
      <div class="tab" data-go="profile"><i>👤</i><span data-i18n="tab_profile">Profile</span></div>
    </div>
  </div>
</div>

<script>
/* ---------- I18N (EN/ID) ---------- */
const I18N = {
  en:{brand:"Watch2Earn",overview_title:"Overview",balance:"Balance",earned:"Total Earned",completed:"Tasks Done",streak:"Streak",
      daily_checkin:"Daily Check-in Bonus",checkin_hint:"Claim your daily reward and keep your streak!",claim_btn:"Claim Today",
      quick_start:"Ads Task Overview",ads_hint:"Start a task and watch till completion to earn rewards.",start_task:"Start Task",
      fallback:"Fallback",ads_title:"Ads Task",ads_sub:"Pick a format below. Rewards are added after completion.",
      ads_item1:"Video Task (pre-roll)",ads_item1_hint:"Watch the video until it finishes",
      ads_item2:"Rewarded Popup",ads_item2_hint:"One tap to open and complete",
      ads_item3:"Rewarded Interstitial",ads_item3_hint:"Full-screen view",
      tg_title:"Telegram Tasks",tg_empty:"No tasks available",ref_title:"Refer & Earn Forever",
      ref_text1:"Earn",ref_text2:"of your friends’ earnings for life.",copy_btn:"Copy",
      wd_title:"Withdraw Funds",your_balance:"Balance",min_wd:"Minimum",withdraw_btn:"Request Withdrawal",
      history_title:"History",history_hint:"Transactions & recent rewards (coming soon)",
      profile_title:"Profile",profile_loading:"Loading profile…",refresh_btn:"Refresh",lang_label:"Language",
      about_title:"App Info",tab_home:"Home",tab_ads:"Ads Task",tab_tg:"TG Tasks",tab_ref:"Refer",tab_withdraw:"Withdraw",tab_profile:"Profile",
      // popups & runtime
      fail:"Failed",verify_fail:"Verification failed",config:"Config",vast_not_set:"Ad source not configured.",
      success:"Success",credited:"+{AMOUNT} USDT credited.",credited_fb:"+{AMOUNT} USDT (fallback).",ad_canceled:"Ad canceled/failed."},
  id:{brand:"Watch2Earn",overview_title:"Ringkasan",balance:"Saldo",earned:"Total Diterima",completed:"Tugas Selesai",streak:"Streak",
      daily_checkin:"Bonus Check-in Harian",checkin_hint:"Klaim reward harian dan jaga streak!",claim_btn:"Klaim Hari Ini",
      quick_start:"Ringkasan Tugas Iklan",ads_hint:"Mulai task dan tonton sampai selesai untuk mendapat reward.",start_task:"Mulai Tugas",
      fallback:"Fallback",ads_title:"Tugas Iklan",ads_sub:"Pilih format di bawah. Reward masuk setelah selesai.",
      ads_item1:"Tugas Video (pre-roll)",ads_item1_hint:"Tonton video sampai selesai",
      ads_item2:"Rewarded Popup",ads_item2_hint:"Sekali tap lalu selesai",
      ads_item3:"Rewarded Interstitial",ads_item3_hint:"Tampilan layar penuh",
      tg_title:"Tugas Telegram",tg_empty:"Belum ada tugas",ref_title:"Ajak Teman & Dapat Selamanya",
      ref_text1:"Dapat",ref_text2:"dari penghasilan teman selamanya.",copy_btn:"Salin",
      wd_title:"Tarik Dana",your_balance:"Saldo",min_wd:"Minimum",withdraw_btn:"Ajukan Penarikan",
      history_title:"Riwayat",history_hint:"Transaksi & reward terbaru (segera hadir)",
      profile_title:"Profil",profile_loading:"Memuat profil…",refresh_btn:"Muat Ulang",lang_label:"Bahasa",
      about_title:"Info Aplikasi",tab_home:"Beranda",tab_ads:"Tugas Iklan",tab_tg:"Tugas TG",tab_ref:"Referral",tab_withdraw:"Tarik",tab_profile:"Profil",
      fail:"Gagal",verify_fail:"Verifikasi gagal",config:"Konfigurasi",vast_not_set:"Sumber iklan belum disetel.",
      success:"Berhasil",credited:"+{AMOUNT} USDT dikredit.",credited_fb:"+{AMOUNT} USDT (fallback).",ad_canceled:"Iklan dibatalkan/gagal."}
};
const tg = window.Telegram.WebApp; tg.expand();
const initData = tg.initData || '';
const userLang = (tg.initDataUnsafe?.user?.language_code || '').slice(0,2).toLowerCase();
const savedLang = localStorage.getItem('w2e_lang');
let LANG = savedLang || (userLang==='id'?'id':'en');
document.documentElement.lang = LANG;
function t(k,vars={}){const s=(I18N[LANG][k]||I18N.en[k]||k);return Object.keys(vars).reduce((a,b)=>a.replaceAll(`{${b}}`,vars[b]),s)}
function applyI18n(){document.querySelectorAll('[data-i18n]').forEach(el=>el.textContent=t(el.dataset.i18n))}
applyI18n();

/* ---------- Helpers & state ---------- */
const $=s=>document.querySelector(s);
const api=(p,b)=>fetch(p,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(b||{})}).then(r=>r.json());
let CFG={vastTag:'',reward:0.01,min_withdraw:1,ref_pct:10,balance:0,total_tasks:0,username:'Guest',user_id:'',streak:0,earned:0};
let FP=null,adDone=false,fbTimer=0,fbNeed=15,lastT=0;

/* Tabs */
const sections=[...document.querySelectorAll('.section')];
$('#tabs').addEventListener('click',e=>{
  const tEl=e.target.closest('.tab'); if(!tEl) return;
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  tEl.classList.add('active'); const go=tEl.dataset.go;
  sections.forEach(s=>s.classList.toggle('active',s.id===go));
  if(go==='profile') loadConfig();
});

/* Language switcher */
const langSel=$('#langSel'); langSel.value=LANG;
langSel.addEventListener('change',()=>{LANG=langSel.value;localStorage.setItem('w2e_lang',LANG);document.documentElement.lang=LANG;applyI18n()});

/* Load config from backend */
async function loadConfig(){
  const d=await api('/api/config',{initData});
  if(!d.ok){tg.showPopup({title:t('fail'),message:t('verify_fail'),buttons:[{type:'ok'}]});return}
  CFG=d;
  $('#uName').textContent=d.username||'User';
  $('#uId').textContent=d.user_id?('#'+d.user_id):'';
  $('#kpiBalance').textContent=`${d.balance.toFixed(2)} USDT`;
  $('#kpiEarned').textContent=`${(d.earned||0).toFixed(2)} USDT`;
  $('#kpiTasks').textContent=d.total_tasks||0;
  $('#kpiStreak').textContent=`${d.streak||0} 🔥`;
  $('#wlBalance').textContent=`${d.balance.toFixed(2)} USDT`;
  $('#wlMin').textContent=`${d.min_withdraw} USDT`;
  $('#rfPct').textContent=`${d.ref_pct}%`;
  $('#fbNeed').textContent=(d.min_watch_sec||15); fbNeed=d.min_watch_sec||15;
  $('#profName').textContent=d.username||'User';
  $('#profJoin').textContent=d.joined_at?`Joined ${d.joined_at}`:'';
  try{const rl=await api('/api/ref/link',{initData}); if(rl.ok) $('#rfLink').value=rl.link;}catch(_){}
}
loadConfig();

/* ----- START TASK (Video pre-roll) ----- */
const startTaskBtn=$('#btnStartTask'); const vastWrap=$('#vastWrap'); const v=$('#vastVideo');
async function startVideoTask(){
  if(!CFG.vastTag){tg.showPopup({title:t('config'),message:t('vast_not_set'),buttons:[{type:'ok'}]});return}
  const s=await api('/api/task/start',{initData}); if(!s.ok){tg.showPopup({title:t('fail'),message:s.error||'unknown',buttons:[{type:'ok'}]});return}
  const taskId=s.task_id; adDone=false; lastT=0; $('#fbNow').textContent='0';
  vastWrap.style.display='block';
  v.innerHTML='<source src="data:video/mp4;base64," type="video/mp4">';
  if(FP&&FP.destroy) try{FP.destroy()}catch(_){}
  FP=fluidPlayer('vastVideo',{layoutControls:{fillToContainer:true,allowDownload:false,playbackRateEnabled:false},
    vastOptions:{adList:[{roll:'preRoll',vastTag:CFG.vastTag,skippable:true}],vpaidMode:'INSECURE',maxAllowedVastTagRedirects:5}});
  FP.on('adEnded', async ()=>{
    if(adDone) return; adDone=true;
    const r=await api('/api/task/complete',{initData,task_id:taskId});
    if(r.ok){tg.showPopup({title:t('success'),message:t('credited',{AMOUNT:CFG.reward}),buttons:[{type:'ok'}]});loadConfig()}
    else{tg.showPopup({title:t('fail'),message:r.error||'unknown',buttons:[{type:'ok'}]})}
  });
  v.addEventListener('timeupdate',()=>{
    const dt=Math.max(0,v.currentTime-lastT); lastT=v.currentTime;
    if(document.visibilityState==='visible'&&!v.paused) fbTimer+=dt;
    $('#fbNow').textContent=String(Math.floor(fbTimer));
    if(!adDone && fbTimer>=fbNeed){
      adDone=true;
      api('/api/task/complete',{initData,task_id:taskId}).then(r=>{
        if(r.ok){tg.showPopup({title:t('success'),message:t('credited_fb',{AMOUNT:CFG.reward}),buttons:[{type:'ok'}]});loadConfig()}
      })
    }
  });
  try{await v.play()}catch(_){}
}
startTaskBtn.addEventListener('click',startVideoTask);
$('#taskVastBtn').addEventListener('click',startVideoTask);

/* ----- Rewarded Popup / Interstitial ----- */
async function runReward(kind,fn){
  const s=await api('/api/task/start',{initData}); if(!s.ok){tg.showPopup({title:t('fail'),message:s.error||'unknown',buttons:[{type:'ok'}]});return}
  const taskId=s.task_id;
  try{
    await fn(); // selesai
    const r=await api('/api/task/complete',{initData,task_id:taskId});
    if(r.ok){tg.showPopup({title:t('success'),message:`+${CFG.reward} USDT`,buttons:[{type:'ok'}]});loadConfig()}
  }catch(_){tg.showPopup({title:'Ad',message:t('ad_canceled'),buttons:[{type:'ok'}]})}
}
$('#taskPopBtn').addEventListener('click',()=>runReward('popup',()=>show_9711117('pop')));
$('#taskIntBtn').addEventListener('click',()=>runReward('interstitial',()=>show_9711117()));

/* ----- Check-in ----- */
$('#btnCheckin').addEventListener('click',async ()=>{
  const r=await api('/api/checkin',{initData});
  if(r.ok){ $('#ciStatus').textContent = `+${r.amount} USDT • Streak ${r.streak} 🔥`; loadConfig(); }
  else { $('#ciStatus').textContent = r.error || t('fail'); }
});

/* ----- Withdraw ----- */
$('#btnWithdraw').addEventListener('click',async ()=>{
  const a=$('#wdAddr').value.trim();
  const r=await api('/api/withdraw',{initData,address:a});
  $('#wdMsg').textContent=r.ok ? (LANG==='id'?'Permintaan dibuat.':'Request created.') : (r.error||t('fail'));
});

/* ----- Copy referral ----- */
$('#btnCopyRef').addEventListener('click',()=>{
  const el=$('#rfLink'); el.select(); document.execCommand('copy');
  tg.HapticFeedback?.notificationOccurred('success');
});

/* Refresh profile */
$('#btnRefresh').addEventListener('click',loadConfig);
</script>
</body>
</html>
