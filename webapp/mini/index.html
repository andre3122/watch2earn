<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Watch2Earn ‚Ä¢ Mini App</title>

<!-- Telegram WebApp SDK -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Fluid Player (VAST) -->
<link rel="preconnect" href="https://cdn.fluidplayer.com" crossorigin>
<script defer src="https://cdn.fluidplayer.com/v3/current/fluidplayer.min.js"></script>

<!-- Monetag (libtl) SDK ‚Äì ganti data-zone sesuai punyamu -->
<script src="https://libtl.com/sdk.js" data-zone="9711117" data-sdk="show_9711117"></script>

<style>
:root{
  --bg:#0b0f14;--card:#0f1622;--glass:rgba(255,255,255,.06);
  --fg:#eaf1f8;--muted:#9eb2c6;--line:#1c2a3a;--acc:#6ae3ff;--acc2:#7affb1;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:radial-gradient(1000px 500px at 10% -10%,#123,transparent),radial-gradient(800px 400px at 100% 0%,#18293c,transparent),var(--bg);color:var(--fg)}
.app{max-width:960px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column}
.header{position:sticky;top:0;z-index:5;backdrop-filter:blur(8px);background:linear-gradient(180deg,rgba(10,14,20,.85),rgba(10,14,20,.55));border-bottom:1px solid var(--line)}
.header .row{display:flex;align-items:center;gap:12px;padding:12px 16px}
.brand{display:flex;align-items:center;gap:10px}
.brand .logo{width:36px;height:36px;border-radius:12px;background:linear-gradient(145deg,#3d2fff,#00c8ff);display:grid;place-items:center;box-shadow:0 8px 20px rgba(0,200,255,.35)}
.brand .logo span{font-weight:800;color:#fff;text-shadow:0 2px 10px rgba(0,0,0,.35)}
.brand .name{font-weight:800;letter-spacing:.2px}
.pill{font-size:12px;color:#0a141e;background:linear-gradient(145deg,var(--acc),var(--acc2));padding:6px 10px;border-radius:999px;font-weight:700}

.content{padding:16px;flex:1}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.card{grid-column:span 12;background:linear-gradient(180deg,var(--card),#0c1320);border:1px solid var(--line);border-radius:16px;padding:14px;box-shadow:0 12px 30px rgba(0,0,0,.35)}
.card h3{margin:0 0 6px 0;font-size:16px}
.row{display:flex;justify-content:space-between;gap:10px;align-items:center}
.kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.kpi .it{background:var(--glass);border:1px solid var(--line);border-radius:14px;padding:10px}
.kpi .it b{font-size:18px}
.btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;background:#152435;color:#eaf1f8;font-weight:700;cursor:pointer}
.btn[disabled]{opacity:.6;cursor:not-allowed}
.btn.acc{background:linear-gradient(145deg,#1b9dfc,#27ffd2);color:#0a1414}
.btn.ghost{background:transparent;border:1px solid var(--line)}
video{width:100%;border-radius:14px;border:1px solid var(--line)}

/* Sections */
.section{display:none;animation:fade .25s ease}
.section.active{display:block}
@keyframes fade{from{opacity:.4;transform:translateY(4px)}to{opacity:1;transform:none}}

/* Bottom Nav */
.nav{position:sticky;bottom:0;z-index:5;background:linear-gradient(0deg,rgba(10,14,20,.95),rgba(10,14,20,.7));border-top:1px solid var(--line);backdrop-filter:blur(8px)}
.tabs{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;padding:8px}
.tab{display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px;border-radius:12px;color:var(--muted);font-size:12px}
.tab.active{background:var(--glass);color:var(--fg);border:1px solid var(--line)}
.tab i{font-style:normal}

/* Responsive columns */
@media(min-width:720px){ .card.col6{grid-column:span 6} }
</style>
</head>
<body>
<div class="app">

  <!-- Header -->
  <div class="header">
    <div class="row">
      <div class="brand">
        <div class="logo"><span>W2E</span></div>
        <div class="name">Watch2Earn</div>
      </div>
      <div class="pill" id="uName">Guest</div>
      <div style="margin-left:auto" class="muted" id="uId"></div>
    </div>
  </div>

  <!-- Content -->
  <div class="content">

    <!-- HOME -->
    <section id="home" class="section active">
      <div class="grid">
        <div class="card">
          <h3>Ringkasan</h3>
          <div class="kpi">
            <div class="it"><div class="muted">Saldo</div><b id="kpiBalance">0.00 USDT</b></div>
            <div class="it"><div class="muted">Selesai</div><b id="kpiTasks">0</b></div>
            <div class="it"><div class="muted">Min WD</div><b id="kpiMin">1 USDT</b></div>
          </div>
        </div>

        <div class="card col6">
          <h3>Mulai Cepat</h3>
          <div class="row">
            <div class="muted">Pre-roll Monetag (VAST)</div>
            <button class="btn acc" id="btnStartVast">Tonton ‚ñ∂</button>
          </div>
          <div id="vastWrap" style="margin-top:10px;display:none">
            <video id="vastVideo" controls preload="metadata" playsinline webkit-playsinline></video>
            <div class="muted" style="margin-top:8px">Fallback: <span id="fbNow">0</span>s / <span id="fbNeed">15</span>s</div>
          </div>
        </div>

        <div class="card col6">
          <h3>Interstitial & Popup (Monetag SDK)</h3>
          <div class="row" style="gap:8px;flex-wrap:wrap">
            <button class="btn" id="btnRewardInt">Rewarded Interstitial</button>
            <button class="btn" id="btnRewardPop">Rewarded Popup</button>
            <button class="btn ghost" id="btnAutoInApp">Enable Auto In-App</button>
          </div>
          <div class="muted" style="margin-top:6px">
            Interstitial/popup memberi reward saat selesai (Promise resolve). Cocok untuk task kecil.
          </div>
        </div>
      </div>
    </section>

    <!-- TASKS -->
    <section id="tasks" class="section">
      <div class="grid">
        <div class="card">
          <h3>Daftar Tugas</h3>
          <div class="muted">Pilih format iklan untuk mendapat reward.</div>
          <div style="display:grid;gap:10px;margin-top:10px">
            <div class="row" style="background:var(--glass);border:1px solid var(--line);border-radius:12px;padding:10px">
              <div>
                <b>Task #VAST-01</b><div class="muted">Pre-roll Monetag (wajib tonton sampai selesai)</div>
              </div>
              <button class="btn acc" id="taskVastBtn">Start ‚ñ∂</button>
            </div>
            <div class="row" style="background:var(--glass);border:1px solid var(--line);border-radius:12px;padding:10px">
              <div>
                <b>Task #POP-01</b><div class="muted">Rewarded Popup (sekali klik)</div>
              </div>
              <button class="btn" id="taskPopBtn">Start ‚ñ∂</button>
            </div>
            <div class="row" style="background:var(--glass);border:1px solid var(--line);border-radius:12px;padding:10px">
              <div>
                <b>Task #INT-01</b><div class="muted">Rewarded Interstitial (layar penuh)</div>
              </div>
              <button class="btn" id="taskIntBtn">Start ‚ñ∂</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- CHECK-IN -->
    <section id="checkin" class="section">
      <div class="grid">
        <div class="card col6">
          <h3>Daily Check-in</h3>
          <div class="muted" id="ciInfo">Check-in harian untuk bonus.</div>
          <div class="row" style="margin-top:10px">
            <button class="btn acc" id="btnCheckin">Check-in Sekarang</button>
            <div class="muted" id="ciStatus"></div>
          </div>
        </div>
        <div class="card col6">
          <h3>Streak</h3>
          <div class="muted">Pertahankan streak untuk bonus ekstra.</div>
          <div id="ciStreak" style="margin-top:8px;font-weight:800;font-size:22px">0 üî•</div>
        </div>
      </div>
    </section>

    <!-- WALLET -->
    <section id="wallet" class="section">
      <div class="grid">
        <div class="card col6">
          <h3>Dompet</h3>
          <div class="muted">Saldo kamu: <b id="wlBalance">0.00 USDT</b></div>
          <div class="muted">Min WD: <b id="wlMin">1 USDT</b></div>
          <div style="display:flex;gap:8px;margin-top:10px">
            <input id="wdAddr" placeholder="Alamat USDT (TRC20/TON/...)">
            <button class="btn acc" id="btnWithdraw">Ajukan Withdraw</button>
          </div>
          <div class="muted" id="wdMsg" style="margin-top:6px"></div>
        </div>
        <div class="card col6">
          <h3>Riwayat</h3>
          <div class="muted">Transaksi & reward terakhir (coming soon)</div>
        </div>
      </div>
    </section>

    <!-- REFERRAL -->
    <section id="ref" class="section">
      <div class="grid">
        <div class="card">
          <h3>Referral</h3>
          <div class="muted">Ajak teman: kamu dapat bonus <span id="rfPct">10%</span> dari task mereka.</div>
          <div style="display:flex;gap:8px;margin-top:10px">
            <input id="rfLink" readonly>
            <button class="btn" id="btnCopyRef">Salin</button>
          </div>
        </div>
      </div>
    </section>

    <!-- PROFILE -->
    <section id="profile" class="section">
      <div class="grid">
        <div class="card col6">
          <h3>Profil</h3>
          <div class="muted" id="pfInfo">Mengambil profil‚Ä¶</div>
          <button class="btn ghost" id="btnRefresh">Refresh</button>
        </div>
        <div class="card col6">
          <h3>Info App</h3>
          <div class="muted">Versi UI: <b>2.0 (multi-menu)</b></div>
          <div class="muted">Player: Fluid (VAST). SDK: Monetag (libtl)</div>
        </div>
      </div>
    </section>

  </div>

  <!-- Bottom Nav -->
  <div class="nav">
    <div class="tabs" id="tabs">
      <div class="tab active" data-go="home"><i>üè†</i>Home</div>
      <div class="tab" data-go="tasks"><i>üéØ</i>Tasks</div>
      <div class="tab" data-go="checkin"><i>üìÖ</i>Check-in</div>
      <div class="tab" data-go="wallet"><i>üíº</i>Wallet</div>
      <div class="tab" data-go="ref"><i>üë•</i>Referral</div>
      <!-- Profile via avatar: -->
    </div>
  </div>
</div>

<script>
/* ---------- Telegram init ---------- */
const tg = window.Telegram.WebApp; tg.expand();
const initData = tg.initData || '';

/* ---------- Helpers ---------- */
const $ = (sel)=>document.querySelector(sel);
const api = (p,body)=>fetch(p,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body||{})}).then(r=>r.json());

/* ---------- State ---------- */
let CFG = { vastTag:'', reward:0.01, min_withdraw:1, ref_pct:10, balance:0, total_tasks:0, username:'Guest', user_id:'' };
let FP=null, adDone=false, fbTimer=0, fbNeed=15, lastT=0;

/* ---------- Tabs ---------- */
const sections = Array.from(document.querySelectorAll('.section'));
document.getElementById('tabs').addEventListener('click',e=>{
  const t = e.target.closest('.tab'); if(!t) return;
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  const go = t.dataset.go;
  sections.forEach(s=>s.classList.toggle('active', s.id===go));
  if(go==='profile') loadConfig();
});

/* ---------- Load Config ---------- */
async function loadConfig() {
  const d = await api('/api/config',{initData});
  if(!d.ok){ tg.showPopup({title:'Gagal',message:'Verifikasi gagal',buttons:[{type:'ok'}]}); return }
  CFG = d;
  $('#uName').textContent = d.username||'User';
  $('#uId').textContent = d.user_id ? ('#'+d.user_id) : '';
  $('#kpiBalance').textContent = `${d.balance.toFixed(2)} USDT`;
  $('#kpiTasks').textContent = d.total_tasks;
  $('#kpiMin').textContent = `${d.min_withdraw} USDT`;
  $('#wlBalance').textContent = `${d.balance.toFixed(2)} USDT`;
  $('#wlMin').textContent = `${d.min_withdraw} USDT`;
  $('#rfPct').textContent = `${d.ref_pct}%`;
  $('#fbNeed').textContent = (d.min_watch_sec || 15);
  fbNeed = d.min_watch_sec || 15;

  // Get referral link
  try{
    const rl = await api('/api/ref/link',{initData});
    if(rl.ok) $('#rfLink').value = rl.link;
  }catch(e){}
}
loadConfig();

/* ---------- VAST (Fluid Player) ---------- */
const btnStartVast = $('#btnStartVast');
const vastWrap = $('#vastWrap'); const v = $('#vastVideo');
btnStartVast.addEventListener('click', async ()=>{
  if(!CFG.vastTag){ tg.showPopup({title:'Config',message:'VAST tag belum diset.',buttons:[{type:'ok'}]}); return }
  const s = await api('/api/task/start',{initData}); if(!s.ok){ tg.showPopup({title:'Gagal',message:s.error||'unknown',buttons:[{type:'ok'}]}); return }
  const taskId = s.task_id; adDone=false; lastT=0; $('#fbNow').textContent='0';
  vastWrap.style.display='block';
  v.innerHTML = '<source src="data:video/mp4;base64," type="video/mp4">';
  if(FP && FP.destroy) try{FP.destroy()}catch(e){}
  FP = fluidPlayer('vastVideo',{
    layoutControls:{fillToContainer:true,allowDownload:false,playbackRateEnabled:false},
    vastOptions:{adList:[{roll:'preRoll',vastTag:CFG.vastTag,skippable:true}],vpaidMode:'INSECURE',maxAllowedVastTagRedirects:5}
  });
  FP.on('adEnded', async ()=>{
    if(adDone) return; adDone=true;
    const r = await api('/api/task/complete',{initData,task_id:taskId});
    if(r.ok){ tg.showPopup({title:'Berhasil',message:`+${CFG.reward} USDT dikredit.`,buttons:[{type:'ok'}]}); loadConfig(); }
    else{ tg.showPopup({title:'Gagal',message:r.error||'unknown',buttons:[{type:'ok'}]}); }
  });
  v.addEventListener('timeupdate', ()=>{
    const dt = Math.max(0, v.currentTime - lastT); lastT = v.currentTime;
    if(document.visibilityState==='visible' && !v.paused) fbTimer += dt;
    $('#fbNow').textContent = String(Math.floor(fbTimer));
    if(!adDone && fbTimer >= fbNeed){
      adDone=true;
      api('/api/task/complete',{initData,task_id:taskId}).then(r=>{
        if(r.ok){ tg.showPopup({title:'Berhasil',message:`+${CFG.reward} USDT (fallback).`,buttons:[{type:'ok'}]}); loadConfig(); }
      });
    }
  });
  try{ await v.play(); }catch(e){}
});
// juga tombol di halaman Tasks
$('#taskVastBtn').addEventListener('click', ()=>btnStartVast.click());

/* ---------- Monetag SDK tasks ---------- */
async function runReward(kindLabel, showFn){
  const s = await api('/api/task/start',{initData}); if(!s.ok){ tg.showPopup({title:'Gagal',message:s.error||'unknown',buttons:[{type:'ok'}]}); return }
  const taskId = s.task_id;
  try{
    await showFn(); // resolve = selesai
    const r = await api('/api/task/complete',{initData,task_id:taskId});
    if(r.ok){ tg.showPopup({title:'Berhasil',message:`+${CFG.reward} USDT (${kindLabel}).`,buttons:[{type:'ok'}]}); loadConfig(); }
  }catch(e){ tg.showPopup({title:'Iklan',message:'Iklan batal/gagal.',buttons:[{type:'ok'}]}); }
}
$('#btnRewardInt').addEventListener('click', ()=> runReward('interstitial', ()=>show_9711117()));
$('#btnRewardPop').addEventListener('click', ()=> runReward('popup', ()=>show_9711117('pop')));
$('#taskIntBtn').addEventListener('click', ()=> $('#btnRewardInt').click());
$('#taskPopBtn').addEventListener('click', ()=> $('#btnRewardPop').click());

let autoEnabled=false;
$('#btnAutoInApp').addEventListener('click', ()=>{
  if(autoEnabled) return;
  autoEnabled=true;
  try{
    show_9711117({type:'inApp',inAppSettings:{frequency:2,capping:0.1,interval:30,timeout:5,everyPage:false}});
    $('#btnAutoInApp').textContent = 'In-App ON';
    tg.HapticFeedback.notificationOccurred('success');
  }catch(e){}
});

/* ---------- Check-in ---------- */
$('#btnCheckin').addEventListener('click', async ()=>{
  const r = await api('/api/checkin',{initData});
  if(r.ok){ $('#ciStatus').textContent = `+${r.amount} USDT ‚Ä¢ Streak ${r.streak} üî•`; loadConfig(); }
  else{ $('#ciStatus').textContent = r.error || 'Gagal'; }
});

/* ---------- Wallet ---------- */
$('#btnWithdraw').addEventListener('click', async ()=>{
  const a = $('#wdAddr').value.trim();
  const r = await api('/api/withdraw',{initData,address:a});
  $('#wdMsg').textContent = r.ok ? `Request ${r.amount} USDT dibuat.` : (r.error||'Gagal');
});

/* ---------- Profile ---------- */
$('#btnRefresh').addEventListener('click', ()=>loadConfig());

</script>
</body>
</html>
