<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Watch2Earn</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
:root{
  --bg:#f6f8fc; --card:#fff; --ink:#0f172a; --muted:#64748b; --line:#e2e8f0;
  --grad: linear-gradient(135deg,#60a5fa,#34d399); /* blue->green */
  --grad2: linear-gradient(135deg,#fca5a5,#fde68a); /* red->yellow */
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,"Segoe UI",Roboto,Arial}
.app{min-height:100vh;display:flex;flex-direction:column}
.header{padding:14px 16px 0}
.brand{display:flex;align-items:center;gap:12px}
.brand .logo{
  width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,#7dd3fc,#86efac);
  display:grid;place-items:center;color:#003b2d;font-weight:900
}
.brand h1{font-size:20px;margin:0}
.badge{margin-left:auto;background:#eef2ff;border:1px solid #dbeafe;color:#334155;border-radius:999px;padding:6px 10px;font-weight:700}
.content{flex:1;padding:12px 12px 92px;max-width:980px;margin:0 auto;width:100%}
.card{
  background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;
  box-shadow:0 10px 30px rgba(2,8,23,.06);margin:10px 0
}
h3{margin:0 0 8px 0;font-size:18px}
.small{font-size:13px;color:var(--muted)}
.row{display:flex;gap:10px;flex-wrap:wrap}
.kpi{flex:1;min-width:140px;padding:12px;border-radius:14px;border:1px solid var(--line);background:#fff}
.kpi .v{font-weight:900;font-size:20px;margin-top:4px}
.btn{
  appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:800;cursor:pointer;background:#e2e8f0;color:#0f172a
}
.btn.primary{background:var(--grad);color:#062a24}
.btn.block{width:100%}
.btn.ghost{background:#fff;border:1px solid var(--line)}
.center{display:grid;place-items:center}

/* bottom nav */
.nav{
  position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid var(--line);
  display:flex;gap:8px;justify-content:space-around;padding:10px 8px 14px;z-index:30
}
.tabbtn{
  flex:1;max-width:160px;display:grid;place-items:center;gap:6px;padding:8px;border-radius:16px;
  border:2px solid #e5e7eb;color:#0f172a;background:#fff;font-weight:800
}
.tabbtn.active{background:#eef2ff;border-color:#c7d2fe}

/* pages */
.page{display:none}
.page.show{display:block}

/* Ads task cards */
.task{
  border:1px solid var(--line);border-radius:16px;padding:12px;background:#fff;margin-top:8px
}
.task h4{margin:0 0 8px 0;font-size:18px}
.task .desc{color:var(--muted);font-size:14px;margin-bottom:10px}

/* Daily 1..7 boxes */
.days{display:grid;grid-template-columns:repeat(7,1fr);gap:10px;margin-top:12px}
.day{
  position:relative;height:72px;display:grid;place-items:center;
  border-radius:14px;border:1px solid var(--line);background:#ffffff;
  font-weight:800;color:#334155;box-shadow:0 6px 14px rgba(15,23,42,.05)
}
.day .lbl{display:flex;flex-direction:column;align-items:center;line-height:1}
.day small{font-weight:700;color:#0f172a;opacity:.85}
.day .ico{position:absolute;top:6px;right:8px;font-size:14px;opacity:.85}
.day.done{background:linear-gradient(145deg,#7dd3fc,#86efac);color:#073b2d;border-color:transparent}
.day.current{
  background:var(--grad2);color:#3a2200;border:2px solid #fbbf24;box-shadow:0 10px 22px rgba(250,204,21,.35)
}
.day.locked{color:#94a3b8;background:linear-gradient(180deg,#f8fafc,#eef2f7)}
.progressBar{height:10px;border-radius:999px;background:#eceff4;margin:10px 0;overflow:hidden}
.progressBar>i{display:block;height:100%;width:25%;background:linear-gradient(90deg,#60a5fa,#34d399)}

/* form */
input{
  width:100%;background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px;font-size:15px;color:#0f172a
}
label{font-size:13px;color:#475569}

/* responsive */
@media (max-width:420px){
  .days{grid-template-columns:repeat(4,1fr)}
}
</style>
</head>
<body>
<div class="app">
  <!-- header -->
  <div class="header">
    <div class="brand">
      <div class="logo">W2E</div>
      <h1>Watch2Earn</h1>
      <div class="badge" id="userBadge">User</div>
    </div>
  </div>

  <!-- content -->
  <div class="content">
    <!-- HOME -->
    <section id="home" class="page show">
      <div class="row">
        <div class="kpi"><div class="small">Balance</div><div class="v" id="kpiBalance">0.00 USDT</div></div>
        <div class="kpi"><div class="small">Total Earned</div><div class="v" id="kpiEarned">0.00 USDT</div></div>
        <div class="kpi"><div class="small">Tasks Completed</div><div class="v" id="kpiTasks">0</div></div>
        <div class="kpi"><div class="small">Daily Streak</div><div class="v"><span id="kpiStreak">0</span> ğŸ”¥</div></div>
      </div>

      <div class="card">
        <h3>Daily Check-in</h3>
        <div class="small">Keep your streak running! (Day <span id="streakDay">1</span>/7)</div>
        <div class="days" id="days">
          <div class="day" data-n="1"><div class="ico">âœ…</div><div class="lbl"><div>Day 1</div><small>+2</small></div></div>
          <div class="day" data-n="2"><div class="ico">â­</div><div class="lbl"><div>Day 2</div><small>+4</small></div></div>
          <div class="day" data-n="3"><div class="ico">ğŸ”’</div><div class="lbl"><div>Day 3</div><small>+6</small></div></div>
          <div class="day" data-n="4"><div class="ico">ğŸ”’</div><div class="lbl"><div>Day 4</div><small>+8</small></div></div>
          <div class="day" data-n="5"><div class="ico">ğŸ”’</div><div class="lbl"><div>Day 5</div><small>+10</small></div></div>
          <div class="day" data-n="6"><div class="ico">ğŸ”’</div><div class="lbl"><div>Day 6</div><small>+12</small></div></div>
          <div class="day" data-n="7"><div class="ico">ğŸ”’</div><div class="lbl"><div>Day 7</div><small>+15</small></div></div>
        </div>
        <div class="progressBar"><i id="streakProg"></i></div>
        <button class="btn primary" id="btnCheckin">Claim Today</button>
        <div class="small" id="checkinNote" style="margin-top:6px"></div>
      </div>
    </section>

    <!-- ADS -->
    <section id="ads" class="page">
      <div class="card">
        <h3>Ads Task</h3>
        <div class="small">Start a task and watch till completion to earn rewards.</div>

        <div class="task">
          <h4>Stream Task (Video)</h4>
          <div class="desc">Watch a pre-roll ad, then continue the video.</div>
          <button class="btn primary block" id="btnStream">Start Task</button>
          <div class="small">Fallback: <span id="fbWatch">0</span>s / <span id="fbNeed">15</span>s</div>
        </div>

        <div class="task">
          <h4>Rewarded Popup</h4>
          <div class="desc">Open a rewarded popup ad. Complete to get reward.</div>
          <button class="btn primary block" id="btnPopup">Show Popup</button>
        </div>

        <div class="task">
          <h4>Interstitial</h4>
          <div class="desc">Show an interstitial ad between actions.</div>
          <button class="btn primary block" id="btnInter">Show Interstitial</button>
        </div>
      </div>
    </section>

    <!-- REFER -->
    <section id="refer" class="page">
      <div class="card">
        <h3>Refer & Earn</h3>
        <div class="small">Earn <span id="refPct">0</span>% of your friendsâ€™ earnings for life.</div>
        <div class="row" style="margin-top:10px">
          <input id="refLink" readonly value=""/>
          <button class="btn ghost" id="copyRef">Copy</button>
        </div>
      </div>

      <div class="card">
        <h3>Referrals List</h3>
        <div id="refList" class="small">No referrals yet.</div>
      </div>
    </section>

    <!-- PROFILE -->
    <section id="profile" class="page">
      <div class="card">
        <h3>Profile</h3>
        <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap">
          <div><div id="pName" style="font-weight:800">User</div></div>
          <div style="text-align:right"><div class="small">Balance</div><div id="pBalance" style="font-weight:800">0.00 USDT</div></div>
        </div>
      </div>

      <div class="card">
        <h3>Withdraw</h3>
        <div class="small" id="wdInfo">Minimum: 1 USDT</div>

        <label class="small" style="display:block;margin-top:10px">Amount</label>
        <input id="wdAmount" inputmode="decimal" placeholder="Enter amount (USDT)"/>
        <div class="small" id="wdMinHint" style="margin-top:6px;opacity:.85">Minimum withdraw is 1 USDT.</div>

        <label class="small" style="display:block;margin-top:12px">Wallet Address</label>
        <input id="wdAddr" placeholder="Wallet address (e.g., TON / TRC20)"/>
        <div class="small" style="margin-top:6px;opacity:.85">
          Enter the address for your selected network (e.g., TON address or TRC20 USDT).
        </div>

        <button class="btn primary block" id="wdBtn" style="margin-top:12px">Request Withdraw</button>
      </div>
    </section>
  </div>

  <!-- nav -->
  <div class="nav">
    <button class="tabbtn active" data-tab="home">Home</button>
    <button class="tabbtn" data-tab="ads">Ads</button>
    <button class="tabbtn" data-tab="refer">Refer</button>
    <button class="tabbtn" data-tab="profile">Profile</button>
  </div>
</div>

<script>
const tg = window.Telegram?.WebApp || { initData:'' };
tg.expand?.();

const $ = (q,ctx=document)=>ctx.querySelector(q);
const $$ = (q,ctx=document)=>Array.from(ctx.querySelectorAll(q));

/* ------- API helper with fallback ------- */
async function api(path, body={}){
  try{
    const r = await fetch(path,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    return await r.json();
  }catch(e){
    // Fallback dummy
    if(path==='/api/config'){
      return {
        ok:true, username:'user', balance:0.02, total_earned:0, total_tasks:2,
        min_withdraw:1, reward:0.01, streak_day:2, ref_bonus_pct:17,
        refer_link:'https://t.me/TonAdsWebBot?start=XXXX',
        referrals:[{u:'alice'},{u:'bob'}],
        vastTag: (window.vastTag||'')
      };
    }
    return {ok:false,error:'offline'};
  }
}

/* ------- tabs ------- */
$$('.tabbtn').forEach(b=>{
  b.onclick=()=>{
    $$('.tabbtn').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    const tab=b.dataset.tab;
    $$('.page').forEach(p=>p.classList.remove('show'));
    $('#'+tab).classList.add('show');
  };
});

/* ------- streak paint ------- */
function paintDays(current){
  $('#streakDay').textContent = current;
  const prog = Math.max(0, Math.min(100, (current-1)/7*100));
  $('#streakProg').style.width = prog + '%';
  $$('.day').forEach(el=>{
    const n = Number(el.dataset.n);
    el.classList.remove('done','current','locked');
    if(n < current){ el.classList.add('done'); el.querySelector('.ico').textContent='âœ…'; }
    else if(n === current){ el.classList.add('current'); el.querySelector('.ico').textContent='â­'; }
    else { el.classList.add('locked'); el.querySelector('.ico').textContent='ğŸ”’'; }
  });
}

/* ------- load all ------- */
async function loadAll(){
  const d = await api('/api/config',{initData:tg.initData||''});
  if(!d.ok){ return; }
  $('#userBadge').textContent = d.username || 'User';
  $('#kpiBalance').textContent = (d.balance||0).toFixed(2)+' USDT';
  $('#kpiEarned').textContent  = (d.total_earned||0).toFixed(2)+' USDT';
  $('#kpiTasks').textContent   = d.total_tasks||0;
  $('#kpiStreak').textContent  = d.streak_day||0;

  $('#pName').textContent = d.username||'User';
  $('#pBalance').textContent = (d.balance||0).toFixed(2)+' USDT';
  $('#wdInfo').textContent = 'Minimum: '+(d.min_withdraw||1)+' USDT';
  $('#wdMinHint').textContent = 'Minimum withdraw is '+(d.min_withdraw||1)+' USDT.';
  $('#refPct').textContent = d.ref_bonus_pct||0;
  $('#refLink').value = d.refer_link||'';

  const list = d.referrals?.length ? d.referrals.map(x=>`â€¢ @${x.u||'user'}`).join('<br>') : 'No referrals yet.';
  $('#refList').innerHTML = list;

  paintDays(Math.max(1, Math.min(7, d.streak_day||1)));
  window.vastTag = d.vastTag || window.vastTag || '';
}
loadAll();

/* ------- clipboard ------- */
$('#copyRef').onclick=()=>{
  navigator.clipboard.writeText($('#refLink').value||'');
  alert('Referral link copied!');
};

/* ------- check-in ------- */
$('#btnCheckin').onclick = async ()=>{
  const r = await api('/api/checkin',{initData:tg.initData||''});
  if(r.ok){
    alert(`+${(r.amount||0).toFixed(2)} USDT`);
    loadAll();
  }else{
    // fallback local once/day
    const k='chk_'+new Date().toDateString();
    if(localStorage.getItem(k)) { $('#checkinNote').textContent='Already claimed today.'; return; }
    localStorage.setItem(k,'1');
    $('#checkinNote').textContent='Claimed (local)';
  }
};

/* ------- Ads: Stream task ------- */
let fbTimer=null, fbWatched=0, fbNeed=15;
function startFallbackTimer(taskId){
  clearInterval(fbTimer); fbWatched=0; $('#fbNeed').textContent=fbNeed; $('#fbWatch').textContent='0';
  fbTimer=setInterval(async ()=>{
    fbWatched++; $('#fbWatch').textContent=String(fbWatched);
    if(fbWatched>=fbNeed){
      clearInterval(fbTimer);
      await api('/api/task/complete',{initData:tg.initData||'',task_id:taskId});
      alert('Task completed (fallback).'); loadAll();
    }
  },1000);
}
$('#btnStream').onclick = async ()=>{
  const r = await api('/api/task/start',{initData:tg.initData||''});
  if(!r.ok){ alert(r.error||'Failed to start task'); return; }
  fbNeed = r.min_watch_sec || 15;
  // jika Monetag VAST sudah dihubungkan oleh backend, jalankan player di server;
  // di FE kita jalankan fallback timer agar tetap dapat reward bila ad terblokir.
  startFallbackTimer(r.task_id);
};

/* ------- Ads: Rewarded Popup / Interstitial ------- */
/* Jika Monetag SDK sudah di-inject (libtl.com), panggil show_XXXX.
   Kalau belum, kita langsung selesaikan sebagai demo/fallback. */
async function completeSimpleTask(){
  const r = await api('/api/task/start',{initData:tg.initData||''});
  if(!r.ok){ alert('Cannot start task'); return; }
  await api('/api/task/complete',{initData:tg.initData||'',task_id:r.task_id});
  alert('Task completed.'); loadAll();
}
$('#btnPopup').onclick = async ()=>{
  if(typeof window.show_9711117==='function'){
    try{
      await window.show_9711117('pop'); await completeSimpleTask(); return;
    }catch(e){}
  }
  await completeSimpleTask();
};
$('#btnInter').onclick = async ()=>{
  if(typeof window.show_9711117==='function'){
    try{
      await window.show_9711117(); await completeSimpleTask(); return;
    }catch(e){}
  }
  await completeSimpleTask();
};

/* ------- Withdraw ------- */
$('#wdBtn').onclick = async ()=>{
  const address = $('#wdAddr').value.trim();
  const amount  = parseFloat($('#wdAmount').value.trim());
  if(!address){ alert('Enter wallet address'); return; }
  if(!(amount>0)){ alert('Enter a valid amount'); return; }
  const r = await api('/api/withdraw',{initData:tg.initData||'', address, amount});
  if(r.ok) alert(`Withdraw request created: ${r.amount||amount} USDT`);
  else alert(r.error||'Failed');
};
</script>
</body>
</html>
