<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Watch2Earn</title>

<link rel="preconnect" href="https://cdn.fluidplayer.com" crossorigin>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script defer src="https://cdn.fluidplayer.com/v3/current/fluidplayer.min.js"></script>

<!-- Monetag Mini App SDK -->
<script src="//libtl.com/sdk.js" data-zone="9711117" data-sdk="show_9711117"></script>

<style>
  :root{
    --bg:#f6f8fb;--card:#ffffff;--ink:#0b1220;--muted:#5b6b82;--line:#e7edf4;
    --brand1:#67d6ff;--brand2:#38e1b7;--brand:#4fd3ca;
    --pill-bg:#eef3f8;--pill-ink:#22324d;--accent:#316aff;
    --success:#22c55e;--warning:#f59e0b;--danger:#ef4444;
    --radius:16px;--pad:16px;--shadow:0 10px 30px rgba(16,24,40,.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:500 16px/1.4 Inter,system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:920px;margin:0 auto;padding:var(--pad);padding-bottom:96px}

  /* Header */
  .appbar{display:flex;align-items:center;gap:12px;margin-bottom:12px}
  .logo{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#7ee8fa,#eec0c6)}
  .title{font-weight:800;font-size:20px}

  /* Pills */
  .chip{margin-left:auto;border-radius:999px;padding:6px 12px;font-weight:700;
        background:rgba(11,18,32,.08);color:var(--pill-ink);border:1px solid var(--line);box-shadow:none}
  .chip small{opacity:.7;margin-left:6px}
  .chipBal{background:rgba(11,18,32,.08);color:var(--pill-ink);border-radius:20px;
           padding:10px 14px;font-weight:900;border:1px solid var(--line);box-shadow:none}

  /* Cards */
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:var(--pad);box-shadow:var(--shadow);margin-bottom:12px}
  .card h3{margin:0 0 8px;font-size:18px}
  .muted{color:var(--muted)}

  /* Buttons */
  .btn{appearance:none;border:0;border-radius:12px;padding:14px 16px;font-weight:800;color:#0b1220;background:#e8f0fb;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:linear-gradient(135deg,var(--brand1),var(--brand2));color:#08210f}
  .btn.ghost{background:var(--pill-bg);color:var(--pill-ink)}
  .btn.block{width:100%}

  /* Grid helpers */
  .grid{display:grid;gap:12px}
  .g2{grid-template-columns:repeat(2,1fr)}
  .g3{grid-template-columns:repeat(3,1fr)}
  @media (min-width:600px){ .g3-lg{grid-template-columns:repeat(3,1fr)} }

  .stack{display:flex;flex-direction:column;gap:10px}

  /* Check-in card */
  .checkin{background:linear-gradient(135deg,#8fd3f4,#c793ff 40%,#f8ae55);color:#0b1220}
  .daygrid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:10px 0 12px}
  .day{background:rgba(255,255,255,.22);backdrop-filter:blur(2px);border:2px solid rgba(255,255,255,.5);
        color:#0b1220;border-radius:14px;padding:10px;text-align:center;font-weight:800}
  .day.lock{opacity:.6}
  .day.done{border-color:#34d399}
  .progress{height:8px;background:rgba(255,255,255,.35);border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0;background:#34d399}

  video{width:100%;border-radius:12px;border:1px solid var(--line);background:#000}

  /* Tabs */
  .tabs{position:fixed;left:0;right:0;bottom:0;background:rgba(255,255,255,.7);backdrop-filter:blur(8px);
        border-top:1px solid var(--line);padding:10px}
  .tabbar{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;max-width:920px;margin:0 auto}
  .tab{border-radius:16px;background:var(--pill-bg);color:var(--pill-ink);text-align:center;padding:12px 10px;font-weight:800;border:none;box-shadow:none}
  .tab small{display:block;color:var(--muted);font-weight:600}
  .tab .ico{width:16px;height:16px;display:block;margin:0 auto 2px}
  .tab.active{background:#f5f9ff;outline:none;border:none}

  .row{display:flex;align-items:center;gap:10px}
  .between{display:flex;align-items:center;justify-content:space-between;gap:10px}

  .field{width:100%;background:#f5f7fb;border:1px solid var(--line);border-radius:12px;padding:14px;color:var(--ink)}
  .hint{font-size:13px;color:var(--muted);margin-top:6px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  .hidden{display:none}

  /* Profile */
  .profileHead{display:flex;align-items:center;gap:14px}
  .avatar{width:56px;height:56px;border-radius:50%;background:#eef2f7;overflow:hidden;
          display:flex;align-items:center;justify-content:center;color:#22324d;font-weight:900}
  .avatar img{width:100%;height:100%;object-fit:cover;border-radius:50%;display:none}
  .avatar-initial{font-size:22px}
  .uname{font-weight:900;font-size:22px}
  .ubio{color:var(--muted);margin-top:2px}
  .pillRight{margin-left:auto}

  /* avoid flash before init */
  html{visibility:hidden}
  html.init-ready{visibility:visible}

  /* Sembunyiin item sesuai request sebelumnya */
  #joinedTxt { display: none !important; }
  /* Kalau mau munculin kembali kartu "Balance/Daily Streak", hapus rule di bawah */
  #screen-home > .grid.g2:first-of-type { display: none !important; }
</style>
</head>
<body>

<script>
  document.addEventListener('DOMContentLoaded', ()=>document.documentElement.classList.add('init-ready'));
  setTimeout(()=>document.documentElement.classList.add('init-ready'), 1500);
</script>

<div class="wrap">
  <!-- Header -->
  <div class="appbar">
    <div class="logo"></div>
    <div>
      <div class="title">Watch2Earn</div>
      <div class="muted" id="joinedTxt">Joined â€”</div>
    </div>
    <div class="chip" id="userChip">User</div>
  </div>

  <!-- HOME -->
  <section id="screen-home">
    <div class="grid g2">
      <div class="card">
        <div class="between">
          <h3>Balance</h3><div class="chipBal"><span id="balTop">0.00</span> USDT</div>
        </div>
        <div class="grid g2">
          <div>
            <div class="muted">Total Earned</div>
            <div class="title" id="totalEarn">0.00 USDT</div>
          </div>
          <div>
            <div class="muted">Tasks Completed</div>
            <div class="title" id="tasksDone">0</div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="between">
          <h3>Daily Streak</h3><div class="chipBal" id="streakChip">0 ðŸ”¥</div>
        </div>
        <div class="muted">Keep checking in daily to boost your streak.</div>
      </div>
    </div>

    <div class="card checkin">
      <h3>Daily Check-in Bonus</h3>
      <div class="muted">Claim your daily reward and keep your streak!</div>
      <div class="daygrid" id="dayGrid"></div>
      <div class="progress"><div class="bar" id="bar"></div></div>
      <div style="height:10px"></div>
      <button class="btn primary block" id="btnClaim">Claim <span id="claimAmt">+0.00</span> USDT</button>
      <div class="hint" id="checkinMsg" style="margin-top:6px"></div>
    </div>

    <div class="card">
      <h3>Invite Friends & Earn</h3>
      <div class="muted" id="refPct">Earn 17% of your friendsâ€™ earnings.</div>
      <div class="row" style="margin-top:8px">
        <input id="refLink" class="field mono" readonly value=""/>
        <button class="btn ghost" id="copyRef">Copy</button>
      </div>
    </div>
  </section>

  <!-- ADS -->
  <section id="screen-ads" class="hidden">
    <!-- (kartu "Ads Task" dihapus sesuai request) -->

    <!-- Follow Telegram Task -->
    <div class="card" style="margin-top:12px">
      <div class="between">
        <div class="title">Follow Telegram</div>
        <div class="muted">Reward: <span id="followRewardTxt">0.01</span> USDT</div>
      </div>
      <div class="muted" style="margin:6px 0 10px">Join channel untuk klaim reward sekali saja.</div>
      <div class="grid g2">
        <button class="btn primary" id="btnOpenChannel">Open Channel</button>
        <button class="btn ghost" id="btnClaimFollow">Claim Reward</button>
      </div>
      <div class="hint" id="followStat" style="margin-top:8px"></div>
    </div>

    <!-- Completed Tasks -->
    <div class="card">
      <h3>Completed Tasks</h3>
      <div class="stack" style="margin-top:8px">
        <button class="btn primary block" id="btnRewPopup">Rewarded Popup</button>
        <button class="btn primary block" id="btnRewInter">Rewarded Interstitial</button>
      </div>
    </div>
  </section>

  <!-- REFER -->
  <section id="screen-refer" class="hidden">
    <div class="card">
      <h3>Refer & Earn</h3>
      <div class="muted">Share your referral link to grow faster.</div>
      <div class="row" style="margin-top:8px">
        <input id="refLink2" class="field mono" readonly value=""/>
        <button class="btn ghost" id="copyRef2">Copy</button>
      </div>
      <div class="card" style="margin-top:12px">
        <div class="between"><div class="muted">Referrals</div><div class="chipBal" id="refCount">0</div></div>
        <div id="refList" class="muted" style="margin-top:8px">Your referrals will appear here.</div>
      </div>
    </div>
  </section>

  <!-- PROFILE -->
  <section id="screen-profile" class="hidden">
    <div class="card">
      <div class="profileHead">
        <div class="avatar">
          <img id="avatarImg" alt="" loading="lazy" referrerpolicy="no-referrer">
        </div>
        <div>
          <div class="uname" id="profName">User</div>
          <div class="ubio" id="joinedDate" style="display:none"></div>
        </div>
        <div class="chipBal pillRight"><span id="balProf">0.00</span> USDT</div>
      </div>
    </div>

    <div class="card">
      <h3>Withdraw</h3>
      <div class="muted">Minimum: <b id="minWdTxt">1</b> USDT</div>
      <div style="height:10px"></div>
      <div>Amount</div>
      <input id="wdAmt" class="field" placeholder="Enter amount (USDT)" inputmode="decimal">
      <div class="hint">Minimum withdraw is <span id="minWdHint">1</span> USDT.</div>
      <div style="height:10px"></div>
      <div>Wallet Address</div>
      <input id="wdAddr" class="field" placeholder="Wallet address (e.g., BSC / BEP20)">
      <div class="hint">Enter the address for your selected network (e.g., BSC (BEP20) address).</div>
      <div style="height:12px"></div>
      <button class="btn primary block" id="btnWithdraw">Request Withdraw</button>
    </div>
  </section>
</div>

<!-- Tabs -->
<div class="tabs">
  <div class="tabbar">
    <button class="tab active" data-tab="home">
      <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 11l9-8 9 8"></path>
        <path d="M5 10v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V10"></path>
      </svg>
      Home
    </button>

    <button class="tab" data-tab="ads">
      <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <rect x="4" y="6" width="16" height="12" rx="3" ry="3"></rect>
        <text x="12" y="14" text-anchor="middle" font-size="8" fill="currentColor" font-family="system-ui, -apple-system, Segoe UI, Roboto">Ad</text>
      </svg>
      Ads Task
    </button>

    <button class="tab" data-tab="refer">
      <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M17 21v-2a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4v2"></path>
        <circle cx="9" cy="7" r="4"></circle>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
      </svg>
      Refer
    </button>

    <button class="tab" data-tab="profile">
      <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M20 21a8 8 0 1 0-16 0"></path>
        <circle cx="12" cy="7" r="4"></circle>
      </svg>
      Profile
    </button>
  </div>
</div>

<script>
(function () {
  const tg = window.Telegram?.WebApp;
  tg && tg.expand();

  const API_URL = '/api';
  const BOT_USERNAME='watch2earnreal_bot';

  /* Helpers */
  const el=id=>document.getElementById(id);
  const g=name=>window[name];
  function toast(msg,err=false){ if(tg?.showPopup) tg.showPopup({title:err?'Oops':'Success',message:msg,buttons:[{type:'ok'}]}); else alert(msg); }
  async function apiPost(path, body){
    const payload = Object.assign({}, body||{}, { initData: tg?.initData || 'dev' });
    const r = await fetch(`${API_URL}${path}`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    let d=null; try{ d=await r.json(); }catch(_){}
    if(!r.ok) throw (d || {error:`HTTP ${r.status}`});
    return d;
  }

  /* Identity */
  const UID=tg?.initDataUnsafe?.user?.id || 'guest';
  const uname=tg?.initDataUnsafe?.user?.username || tg?.initDataUnsafe?.user?.first_name || 'User';
  el('userChip').textContent=uname;
  el('profName').textContent=uname;

  // Avatar
  const avImg=document.getElementById('avatarImg');
  const avWrap=document.querySelector('.profileHead .avatar');
  function showInitial(){ if(!avWrap) return; avWrap.classList.add('avatar-initial'); avWrap.textContent=(uname?.[0]||'U').toUpperCase(); }
  function setAvatar(url){
    if(!url||!avImg){showInitial();return;}
    const test=new Image(); test.referrerPolicy='no-referrer';
    test.onload=()=>{ avImg.src=url; avImg.style.display='block'; if(avWrap) avWrap.textContent=''; };
    test.onerror=showInitial; test.src=url;
  }
  setAvatar(tg?.initDataUnsafe?.user?.photo_url || tg?.initData?.user?.photo_url || '');

  /* ====== Server Config & Me ====== */
  let DEV_MODE=false, FOLLOW_REWARD=0.01, MIN_WITHDRAW=1, REF_BONUS_PCT=17, CHECK_AMTS=[0.02,0.04,0.06,0.08,0.10,0.12,0.15];
  let ME={ balance:0,total_earned:0,total_tasks:0 };

  function syncMeUI(){
    if(el('balTop')) el('balTop').textContent = (+ME.balance).toFixed(2);
    if(el('balProf')) el('balProf').textContent = (+ME.balance).toFixed(2);
    if(el('totalEarn')) el('totalEarn').textContent = (+ME.total_earned).toFixed(2)+' USDT';
    if(el('tasksDone')) el('tasksDone').textContent = (+ME.total_tasks);
  }
  async function refreshMe(){
    try{
      const d = await apiPost('/me',{});
      if(d?.ok){ ME = { balance:+d.balance, total_earned:+d.total_earned, total_tasks:+d.total_tasks }; syncMeUI(); }
    }catch(e){ /* ignore */ }
  }

  async function loadConfig(){
    try{
      const cfg = await apiPost('/config',{});
      if(cfg?.ok){
        DEV_MODE = !!cfg.dev_mode;
        FOLLOW_REWARD = +cfg.follow_reward || FOLLOW_REWARD;
        MIN_WITHDRAW  = +cfg.min_withdraw  || MIN_WITHDRAW;
        REF_BONUS_PCT = +cfg.ref_bonus_pct || REF_BONUS_PCT;
        CHECK_AMTS    = (cfg.checkin_amounts||CHECK_AMTS).slice(0,7);
        if(el('followRewardTxt')) el('followRewardTxt').textContent = FOLLOW_REWARD.toFixed(2);
        if(el('minWdTxt')) el('minWdTxt').textContent = MIN_WITHDRAW;
        if(el('minWdHint')) el('minWdHint').textContent = MIN_WITHDRAW;
        if(el('refPct')) el('refPct').textContent = `Earn ${REF_BONUS_PCT}% of your friendsâ€™ earnings.`;
        // grid 7 hari
        const dayGrid = el('dayGrid');
        if(dayGrid){ dayGrid.innerHTML='';
          for(let i=0;i<7;i++){
            const d=document.createElement('div');
            d.className='day lock';
            d.innerHTML=`Day ${i+1}<div style="font-weight:900">${(CHECK_AMTS[i]||0).toFixed(2)}</div>`;
            dayGrid.appendChild(d);
          }
        }
      }
    }catch(e){ console.error(e); toast(e?.error||'Config error', true); }
  }

  /* ====== CHECK-IN (server) ====== */
  const btnClaim=el('btnClaim'), bar=el('bar'), claimAmt=el('claimAmt'), dayGrid=el('dayGrid'), checkinMsg=el('checkinMsg');
  async function loadCheckin(){
    try{
      const st = await apiPost('/checkin/status',{});
      if(!st?.ok) throw st;
      const streak = +st.streak||0;
      const can = !!st.can_claim;
      const nextAmt = +st.next_amount||0;
      if(bar) bar.style.width = (Math.min(streak/7,1)*100)+'%';
      if(claimAmt) claimAmt.textContent = '+'+nextAmt.toFixed(2);
      if(btnClaim){
        btnClaim.disabled = !can;
        btnClaim.textContent = can ? `Claim ${nextAmt.toFixed(2)} USDT` : 'Already claimed today';
      }
      if(dayGrid){
        [...dayGrid.children].forEach((c,i)=>{
          c.classList.remove('done'); c.classList.add('lock');
          if(i < streak) c.classList.add('done');
          if(i <= streak) c.classList.remove('lock');
        });
      }
      if(checkinMsg) checkinMsg.textContent = can ? '' : 'You can claim again tomorrow.';
    }catch(e){ console.error(e); if(checkinMsg) checkinMsg.textContent = e?.error||'Check-in error'; }
  }
  if(btnClaim) btnClaim.addEventListener('click', async ()=>{
    try{
      btnClaim.disabled = true;
      const res = await apiPost('/checkin/claim',{});
      if(res?.ok){
        toast(`+${(+res.balance_delta||0).toFixed(2)} USDT added`);
        await refreshMe();
        await loadCheckin();
      }else{
        toast(res?.error||'Error', true);
      }
    }catch(e){
      toast(e?.error||'Server error', true);
    }finally{
      btnClaim.disabled = false;
    }
  });

  /* ====== Ads (server-validated via S2S) ====== */
  function genReqId(){ return `${Date.now()}_${Math.random().toString(36).slice(2,8)}`; }
  function wait(ms){ return new Promise(r=>setTimeout(r, ms)); }

  async function showMonetag(opts){
    // aman kalau SDK ga return promise
    try{
      const fn = g('show_9711117');
      const r = fn?.(opts);
      if (r && typeof r.then === 'function') await r;
    }catch(_){}
  }

  async function runRewarded(label){
    // 1) snapshot sebelum nonton
    const before = { ...ME };
    const reqid = genReqId();

    // 2) trigger iklan (sub1 = telegram_id, sub2 = reqid)
    const sdkOpts = (label === 'popup')
      ? { type:'pop', sub1: UID, sub2: reqid }
      : { sub1: UID, sub2: reqid };
    showMonetag(sdkOpts).catch(()=>{ /* no-op */ });

    // 3) polling state dari server (menunggu postback mem-credit)
    const deadline = Date.now()+90000; // 90s
    let credited = false;
    while(Date.now() < deadline){
      await wait(3000);
      await refreshMe();
      if (ME.total_tasks > before.total_tasks || ME.balance > before.balance) { credited=true; break; }
    }
    if (credited) {
      const delta = (ME.balance - before.balance);
      toast(`+${delta.toFixed(6)} USDT credited (server)`);
    } else {
      toast('Ad completed. Reward is being processed by server. Try again in a moment.', false);
    }
  }

  const btnRewPopup=el('btnRewPopup'); if(btnRewPopup) btnRewPopup.onclick=()=>runRewarded('popup');
  const btnRewInter=el('btnRewInter'); if(btnRewInter) btnRewInter.onclick=()=>runRewarded('inter');

  /* ====== Follow Telegram (server) ====== */
  const CHANNEL_USERNAME='watch2earnreal';
  const btnOpenChannel=el('btnOpenChannel'); if(btnOpenChannel) btnOpenChannel.onclick=()=>{
    const url=`https://t.me/${CHANNEL_USERNAME}`;
    if(tg?.openTelegramLink) tg.openTelegramLink(url); else window.open(url,'_blank');
  };
  const btnClaimFollow=el('btnClaimFollow'), followStat=el('followStat');
  if(btnClaimFollow) btnClaimFollow.onclick=async ()=>{
    if(!tg?.initData){ toast('Please open from Telegram (or enable DEV_MODE on server).', true); return; }
    btnClaimFollow.disabled = true; if(followStat) followStat.textContent='Checking...';
    try{
      const res = await apiPost('/follow/claim',{});
      if(res?.ok){
        await refreshMe();
        const d = +res.balance_delta||0;
        if (d > 0){ if(followStat) followStat.textContent='Reward claimed âœ”'; toast(`+${d.toFixed(2)} USDT`); }
        else { if(followStat) followStat.textContent='Already claimed before.'; }
      }else{
        if(followStat) followStat.textContent = res?.error || 'Error';
      }
    }catch(e){
      const msg=e?.error || e?.message || 'Server error';
      if(followStat) followStat.textContent = msg; toast(msg,true);
    }finally{ btnClaimFollow.disabled=false; }
  };

  /* ====== Withdraw (server) ====== */
  const btnWithdraw=el('btnWithdraw'); if(btnWithdraw) btnWithdraw.addEventListener('click',async ()=>{
    const amt=parseFloat((el('wdAmt')?.value||'0').replace(',','.'));
    const addr=(el('wdAddr')?.value||'').trim();
    try{
      const res = await apiPost('/withdraw',{ amount: amt, address: addr });
      if(res?.ok){
        toast(`Withdrawal requested: ${(+res.amount).toFixed(2)} USDT`);
        await refreshMe();
      }else{
        toast(res?.error || 'Withdraw error', true);
      }
    }catch(e){
      toast(e?.error || 'Withdraw error', true);
    }
  });

  /* Tabs */
  const screens={home:el('screen-home'),ads:el('screen-ads'),refer:el('screen-refer'),profile:el('screen-profile')};
  document.querySelectorAll('.tab').forEach(b=>{
    b.addEventListener('click',()=>{
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      b.classList.add('active');
      const k=b.dataset.tab;
      Object.entries(screens).forEach(([key,sec])=>{ if(sec) sec.classList.toggle('hidden', key!==k); });
      window.scrollTo({top:0,behavior:'instant'});
    });
  });

  // Bootstrap
  (async function init(){
    await loadConfig();
    await refreshMe();
    await loadCheckin();
    // auto refresh tiap 15s biar UI ke-sync sama server
    setInterval(refreshMe, 15000);
  })();

})();
</script>
</body>
</html>
